<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ´ªè’ä»™å½• - ç ´å¢ƒçœŸä¼ ç‰ˆ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", "Microsoft YaHei", sans-serif; background-color: #edebe1; color: #5c5346; text-align: center; margin: 0; padding: 0; user-select: none; display: flex; justify-content: center; height: 100vh; overflow: hidden; -webkit-tap-highlight-color: transparent;}
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: #b5c7b9; border-radius: 4px; }
        
        #rebirth-flash { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: radial-gradient(circle, #fff 0%, #fde7cc 50%, rgba(255,255,255,0) 100%); z-index: 10000; opacity: 0; pointer-events: none; transition: opacity 0.8s ease-in-out; display: none; align-items: center; justify-content: center; }
        .rebirth-text { font-size: 55px; font-weight: 900; color: #d48a42; letter-spacing: 8px; text-shadow: 0 0 20px #fff, 0 4px 5px rgba(0,0,0,0.2); opacity: 0; transform: scale(0.2); transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .viewport { display: flex; flex-direction: column; width: 100%; max-width: 500px; height: 100vh; background: #f7f5ef; box-shadow: 0 0 20px rgba(92, 83, 70, 0.15); transition: opacity 1s ease-in-out; position: relative;}
        
        .top-panel { padding: 6px 12px 6px 12px; background: rgba(249,247,242,0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 2px solid #e8e3d8; flex-shrink: 0; position:relative; z-index: 10; box-shadow: 0 4px 10px rgba(120,158,131,0.06);}
        .scroll-panel { flex: 1; overflow-y: auto; padding: 12px; background-color: #f7f5ef; background-image: radial-gradient(#e3dfd3 1px, transparent 1px); background-size: 14px 14px; position: relative; }
        
        .tab-bar { display: flex; flex-shrink: 0; background: #fbfaeb; border-top: 1px solid #e8e3d8; height: 60px; box-shadow: 0 -2px 10px rgba(0,0,0,0.04); padding-bottom: env(safe-area-inset-bottom);}
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #9c9285; font-size: 11px; font-weight: bold; cursor: pointer; transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); border-bottom: 3px solid transparent;}
        .tab-icon { font-size: 20px; margin-bottom: 2px; filter: grayscale(1); transition: 0.3s; opacity: 0.8;}
        .tab-item.active { color: #5a8a65; background: radial-gradient(ellipse at bottom, rgba(90,138,101,0.08) 0%, transparent 60%); position: relative; }
        .tab-item.active .tab-icon { filter: grayscale(0) drop-shadow(0 0 4px rgba(90,138,101,0.2)); transform: translateY(-2px); opacity: 1;}
        .tab-item.active::after { content: ''; position: absolute; bottom: 0; left: 30%; width: 40%; height: 3px; background: #5a8a65; border-radius: 3px 3px 0 0;}

        /* åŸç”Ÿå…œåº•ç”¨å°åœ†çƒï¼Œé˜²æ­¢æœªå¡«é…ç½®å›¾ */
        .gold-icon { display: inline-flex; justify-content: center; align-items: center; background: radial-gradient(circle at top left, #f6b93b, #e58e26); color: #fff; font-size: 10px; font-weight: 900; width: 16px; height: 16px; border-radius: 50%; box-shadow: 0 1px 2px rgba(0,0,0,0.2); text-shadow: 0 1px 0px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.5);}
        .dsp-icon { display: inline-flex; justify-content: center; align-items: center; background: radial-gradient(circle at top left, #a29bfe, #6c5ce7); color: #fff; font-size: 10px; font-weight: 900; width: 16px; height: 16px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 1px 2px rgba(0,0,0,0.1); text-shadow: 0 1px 0px rgba(0,0,0,0.2);}

        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .header-name { font-size: 14px; font-weight: 900; color: #5a8a65; border-left: 4px solid #789e83; padding-left: 6px; letter-spacing: 0.5px;}
        .save-load-btn { background: #fff; color: #7f786d; border: 1px solid #d5ceb8; padding: 4px 8px; border-radius: 10px; cursor: pointer; font-size: 11px; margin-left: 4px; box-shadow: 0 2px 2px rgba(0,0,0,0.03); font-weight:bold; transition: 0.1s;}
        
        .stats-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; background: rgba(255,255,255,0.65); border: 1px solid #e1dcd0; border-radius: 10px; padding: 5px; box-shadow: inset 0 2px 8px rgba(255,255,255,1), 0 2px 5px rgba(92,83,70,0.03); margin-bottom: 0px; }
        .stats-item { background: #fcfbf6; border-radius: 6px; padding: 3px 2px; text-align: center; border: 1px solid #f2eedf; font-size: 9px; color: #9c9285; line-height: 1.4; box-shadow: 0 2px 3px rgba(0,0,0,0.02); overflow: hidden; white-space: nowrap; font-weight:bold;}
        .stats-item .sv { display: block; font-size: 12px; font-weight: 900; margin-top: 1px; color: #5a8a65; }

        .monster-area { position: relative; min-height: 310px; flex: 1; border-radius: 12px; border: 2px solid #cedbcc; box-shadow: inset 0 0 15px rgba(255,255,255,0.7), 0 4px 10px rgba(92,83,70,0.08); background: linear-gradient(180deg, #e5eedf 0%, #f2f5ed 50%, #dee7d9 100%); overflow: hidden; display: flex; flex-direction: column; background-position: center; background-size: cover; background-repeat: no-repeat;}
        
        .stage-info { display: inline-block; background: rgba(255,255,255,0.85); border: 1px solid #b5c7b9; padding: 4px 12px; border-radius: 12px; color: #5a8a65; font-size: 11px; font-weight: 900; position: absolute; top: 10px; left: 10px; box-shadow: 0 2px 4px rgba(90,138,101,0.08); z-index: 15;}
        .boss-timer { font-size: 11px; color: #d66453; margin-left: 5px; animation: pulseText 1s infinite alternate; }
        @keyframes pulseText { from { opacity: 1; } to { opacity: 0.5; } }
        
        .gold-display { position: absolute; right: 10px; top: 10px; margin: 0; font-size: 15px; padding: 3px 12px; z-index: 15; border-radius: 15px; background: #fffcf4; border: 2px solid #ecd3ac; color: #d48a42; box-shadow: 0 3px 6px rgba(212,138,66,0.15), inset 0 2px 3px rgba(255,255,255,1); font-weight: 900; letter-spacing: 1px;}
        
        .battle-stage { position: relative; flex: 1; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10;}
        #avatars-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        
        .monster-wrapper { position: relative; display: flex; align-items: center; justify-content: center; z-index: 10; cursor: pointer; transition: transform 0.05s;}
        .monster-wrapper:active { transform: translateY(6px); }
        .monster-wrapper::after { content: ''; position: absolute; left: 50%; transform: translateX(-50%); height: 18px; background: radial-gradient(ellipse, rgba(0,0,0,0.25) 0%, transparent 70%); z-index: 1; pointer-events: none;}
        
        .monster { position: absolute; left: 0; top: 0; width: 100%; height: 100%; box-sizing: border-box; background: linear-gradient(135deg, #bdd5cc, #e1e8d5); border-radius: 20%; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; box-shadow: inset 0 0 10px rgba(255,255,255,0.8), 0 4px 10px rgba(0,0,0,0.1); transition: border-radius 0.2s; z-index: 10; pointer-events: none;}
        .monster.hit { animation: hitReaction 0.15s ease-out; }
        @keyframes hitReaction { 0% { filter: brightness(1); } 20% { filter: brightness(1.3) contrast(1.2) drop-shadow(0 0 15px #d66453); transform: rotate(2deg); } 100% { filter: brightness(1); transform: rotate(0deg); } }
        
        .monster.boss { border-radius: 50%; border: 3px solid #d66453; background: linear-gradient(135deg, #f3b1aa, #e78272); animation: rainbowShadow 2s linear infinite, bossFloat 3s infinite ease-in-out; }
        @keyframes bossFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes rainbowShadow { 0% { box-shadow: 0 0 12px rgba(214,100,83,0.5); } 50% { box-shadow: 0 0 15px rgba(230,170,100,0.5); } 100% { box-shadow: 0 0 12px rgba(214,100,83,0.5); } }

        /* ğŸ”¥å½»åº•æ‹”é™¤å‡ºç”Ÿæ­»äº¡æ¯”ä¾‹ç¼©æ”¾åŠ¨ç”» */
        .monster-ghost { position: absolute; left: 0; top: 0; width: 100%; height: 100%; box-sizing: border-box; border-radius: 20%; display: flex; align-items: center; justify-content: center; z-index: 15; pointer-events: none; animation: ghost-shatter 0.35s forwards cubic-bezier(0.1, 0.9, 0.2, 1); border: 2px solid transparent;}
        .monster-ghost.boss { border-radius: 50%; }
        @keyframes ghost-shatter { 0% { transform: rotate(0deg); opacity: 0.8; filter: brightness(1.2); } 100% { transform: translateY(-15px) rotate(15deg); opacity: 0; filter: blur(4px) brightness(1.5); } }
        
        .monster.spawn { animation: drop-spawn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards !important; }
        @keyframes drop-spawn { 0% { transform: translateY(-100px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        
        .dust-l, .dust-r { position: absolute; bottom: -5px; width: 35px; height: 12px; background: rgba(181,199,185,0.7); border-radius: 50%; z-index: 5; pointer-events: none; filter: blur(2px); }
        .dust-l { left: -10px; animation: dust-anim-l 0.4s forwards ease-out; }
        .dust-r { right: -10px; animation: dust-anim-r 0.4s forwards ease-out; }
        @keyframes dust-anim-l { 0% { transform: translate(15px, 5px) scale(0.5); opacity:1; } 100% { transform: translate(-45px, -10px) scale(2.2); opacity:0; } }
        @keyframes dust-anim-r { 0% { transform: translate(-15px, 5px) scale(0.5); opacity:1; } 100% { transform: translate(45px, -10px) scale(2.2); opacity:0; } }

        .avatar { position: absolute; display: none; z-index: 5; pointer-events: none; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.15)); text-shadow: 0 1px 0 rgba(255,255,255,0.7); margin: 0;}
        .avatar.active { display: block; animation: avatar-jitter 0.1s infinite linear; }
        @keyframes avatar-jitter { 
            0%   { margin-left: 0px; margin-top: 0px; filter: brightness(1.1); transform: translate(-50%, -50%) rotate(0deg); } 
            25%  { margin-left: 2px; margin-top: -1px; transform: translate(-50%, -50%) rotate(4deg); } 
            50%  { margin-left: -2px; margin-top: 2px; filter: brightness(0.9); transform: translate(-50%, -50%) rotate(-4deg); } 
            75%  { margin-left: -1px; margin-top: -2px; transform: translate(-50%, -50%) rotate(4deg); } 
            100% { margin-left: 1px; margin-top: 1px; filter: brightness(1.1); transform: translate(-50%, -50%) rotate(-4deg); } 
        }

        .hp-bar-container { width: 75%; height: 14px; background: #e8e3d8; border-radius: 8px; overflow: hidden; position: relative; border: 2px solid #fff; box-shadow: 0 0 0 1px #d5ceb8, 0 3px 5px rgba(0,0,0,0.05); z-index: 10;}
        .hp-bar { height: 100%; background: linear-gradient(90deg, #e78272 0%, #d66453 100%); width: 100%; transition: width 0.1s linear;}
        .hp-text { position: absolute; top: 0; left: 0; width: 100%; text-align: center; font-size: 10px; line-height: 14px; font-weight: 900; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.4); }
        
        .challenge-btn { position: absolute; bottom: 10px; right: 10px; background: linear-gradient(180deg, #f2a65a 0%, #d48a42 100%); color: white; border: 2px solid #fff; padding: 5px 14px; border-radius: 15px; cursor: pointer; font-size: 12px; font-weight: 900; display: none; box-shadow: 0 3px 6px rgba(212,138,66,0.3), inset 0 2px 2px rgba(255,255,255,0.4); z-index: 11;}
        .challenge-btn:active { transform: translateY(2px); box-shadow: 0 1px 3px rgba(212,138,66,0.3); }
        
        .tab-content { display: none; animation: fadeIn 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

        .upgrades { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        @media (max-width: 450px) { .upgrades { grid-template-columns: 1fr; } }

        .upg-item { position: relative; overflow: hidden; background: rgba(255,255,255,0.8); border: 1px solid #e1dcd0; border-radius: 10px; padding: 10px; display: flex; flex-direction: column; gap: 5px; box-shadow: 0 2px 6px rgba(92,83,70,0.03); text-align: left; transition: transform 0.2s;}
        .upg-item.disabled-in-auto { opacity: 0.6; pointer-events: none; filter: grayscale(10%); }
        .summon-watermark { position: absolute; right: -5px; top: 15px; width: 80px; height: 80px; background-position: right center; background-size: contain; background-repeat: no-repeat; opacity: 0.12; pointer-events: none; z-index: 0; filter: grayscale(20%);}

        .upg-item .title-row { position:relative; z-index:1; display: flex; justify-content: space-between; align-items: center; font-weight: 900; font-size: 13px; color: #5c5346; border-bottom: 1px dotted #e8e3d8; padding-bottom: 4px; margin-bottom: 2px;}
        .lvl-badge { background: #fffdf5; padding: 2px 6px; border-radius: 6px; border: 1px solid #ecd3ac; color: #d48a42; font-size: 10px; margin-right: 4px; font-weight: 900;}
        .upg-item .desc-row { position:relative; z-index:1; font-size: 11px; line-height: 1.4; min-height: 32px; background: rgba(247,245,239,0.5); padding: 4px 6px; border-radius: 6px; color: #7f786d; font-weight:bold;}
        
        .upg-actions { position:relative; z-index:1; display: flex; gap: 5px; margin-top: 4px;}
        .upg-act-btn { flex: 1; background: linear-gradient(180deg, #85bb94 0%, #689f77 100%); border: none; color: #fff; border-radius: 6px; padding: 6px 2px; font-size: 11px; font-weight: 900; box-shadow: 0 3px 0 #528260, inset 0 1px 2px rgba(255,255,255,0.3); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; white-space: nowrap; line-height:1.1;}
        .upg-act-btn:active:not(:disabled) { transform: translateY(3px); box-shadow: 0 0 0 #528260, inset 0 1px 2px rgba(0,0,0,0.1) !important; }
        .upg-act-btn.btn-10x { background: linear-gradient(180deg, #f2a65a 0%, #d48a42 100%); box-shadow: 0 3px 0 #bc722f, inset 0 1px 2px rgba(255,255,255,0.3); }
        .upg-act-btn.btn-10x:active:not(:disabled){ transform: translateY(3px); box-shadow: 0 0 0 #bc722f; }
        .upg-act-btn:disabled { background: #d5ceb8 !important; color: #f7f5ef !important; box-shadow: 0 3px 0 #c2bba7 !important; cursor: not-allowed; }
        
        .upg-act-btn * { pointer-events: none; }

        .treasure-header { font-size: 13px; color: #d48a42; font-weight: 900; margin-bottom: 10px; padding: 10px; background: #fff; border-radius: 10px; text-align: left; border: 1px solid #ecd3ac; border-left: 4px solid #f6b93b; box-shadow: 0 2px 6px rgba(212,138,66,0.05);}
        .treasure-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .treasure-item { background: rgba(255,255,255,0.7); border: 1px solid #e1dcd0; border-radius: 10px; padding: 10px; font-size: 11px; box-shadow: 0 2px 6px rgba(92,83,70,0.03); display:flex; flex-direction:column; justify-content:center; text-align:left;}
        .treasure-item.locked { filter: grayscale(50%) opacity(0.8); background: #f2efe9; }
        .treasure-item.owned { border-left: 3px solid #f6b93b; background:#fffcf4;}
        
        .quest-item { background: #fff; padding: 12px 14px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border: 1px solid #e8e3d8; border-left: 4px solid #5a8a65; box-shadow: 0 2px 8px rgba(92,83,70,0.04); text-align: left;}
        .btn-claim { background: #f2efe9; color: #9c9285; border: none; padding: 6px 14px; border-radius: 6px; font-weight: 900; cursor: not-allowed; min-width:70px; text-align:center;}
        .btn-claim.active { background: linear-gradient(180deg, #f6b93b 0%, #e58e26 100%); color: #fff; cursor: pointer; box-shadow: 0 3px 0 #cc7f22; text-shadow: 0 1px 1px rgba(0,0,0,0.2);}
        .btn-claim.active:active { transform: translateY(3px); box-shadow: none; }
        .btn-claim.done { background: #fff; border: 1px solid #d5ceb8; color: #789e83; box-shadow:none;}

        .rebirth-area { background: #fff; border: 2px dashed #b5c7b9; padding: 20px 15px; border-radius: 12px; margin-top: 10px; display: block; box-shadow: 0 4px 15px rgba(92,83,70,0.05);}
        .rebirth-btn { background: linear-gradient(180deg, #f2a65a 0%, #d48a42 100%); color: #fff; font-size: 20px; font-weight: 900; padding: 12px 25px; border: 2px solid #fff; border-radius: 25px; cursor: pointer; box-shadow: 0 5px 0 #bc722f, inset 0 2px 2px rgba(255,255,255,0.4); text-shadow: 0 1px 2px rgba(0,0,0,0.3); letter-spacing: 2px; transition: 0.1s; width: 100%;}
        .rebirth-btn:active:not(:disabled) { transform: translateY(5px); box-shadow: 0 0 0 #bc722f; }
        .rebirth-btn:disabled { background: #e8e3d8 !important; color: #cfc6b6 !important; cursor: not-allowed; box-shadow: 0 5px 0 #d5ceb8 !important; border-color:transparent;}

        .lb-title { font-size: 14px; color: #5a8a65; font-weight: 900; margin-bottom: 12px; padding: 10px; background: #fff; border-radius: 10px; text-align: left; border: 1px solid #e1dcd0; border-left: 4px solid #789e83; }
        .lb-list { display: flex; flex-direction: column; gap: 6px; padding-bottom: 20px;}
        .lb-item { display: flex; align-items: center; justify-content: space-between; background: #fff; padding: 12px 14px; border-radius: 10px; font-size: 13px; font-weight:900; color: #7f786d; border: 1px solid #e1dcd0; transition: 0.3s; box-shadow: 0 2px 4px rgba(92,83,70,0.02);}
        .lb-rank { width: 50px; flex-shrink: 0; text-align: left; font-size: 15px; }
        .lb-name { flex: 1; text-align: left; color:#5c5346;}
        .lb-round { color: #d48a42; }
        
        .lb-item.rank-1 { background: #fffcf4; border: 1px solid #ecd3ac; transform: scale(1.02); box-shadow: 0 4px 10px rgba(212,138,66,0.1); z-index: 3;}
        .lb-item.rank-2 { background: #f7f5ef; border: 1px solid #d5ceb8; z-index: 2;}
        .lb-item.rank-3 { background: #fdfaf3; border: 1px solid #e8e3d8; z-index: 1;}
        .lb-item.is-player { border: 2px solid #5a8a65; background: #f1f6f2 !important; box-shadow: 0 0 10px rgba(90,138,101,0.2); transform: scale(1.02); z-index: 4;}
        .lb-item.is-player .lb-rank, .lb-item.is-player .lb-name, .lb-item.is-player .lb-round { color: #5a8a65 !important; }

        .auto-compact-bar { background: #fff; border: 1px solid #e1dcd0; border-radius: 10px; padding: 12px; margin-top: 15px; box-shadow: 0 2px 8px rgba(92,83,70,0.03);}
        .auto-input { background: #f7f5ef; border: 1px solid #d5ceb8; color: #d48a42; font-weight: 900; text-align: center; width: 50px; padding: 6px; border-radius: 6px; font-size:14px; margin: 0 4px;}
        .auto-btn { background: #fff; color: #5a8a65; border: 2px solid #789e83; padding: 6px 14px; border-radius: 8px; font-weight: 900; cursor: pointer; font-size:13px; box-shadow: 0 3px 0 #789e83; transition:0.1s;}
        .auto-btn:active { transform: translateY(3px); box-shadow: none; }
        .auto-btn.active { background: #d66453; border-color: #c45749; color: #fff; box-shadow: 0 3px 0 #a94b40;}

        /* å³ä¸ŠæŠ›ç‰©çº¿è·³åŠ¨é£˜ä¼¤ */
        .floating-damage { position: absolute; color: #fff; font-weight: 900; font-size: 18px; pointer-events: none; animation: floatHitUp 0.8s forwards cubic-bezier(0.1, 0.8, 0.4, 1); font-family: 'Impact', 'Arial Black', sans-serif; -webkit-text-stroke: 1px #5c5346; text-shadow: 1px 1px 0 rgba(0,0,0,0.3); z-index: 20; letter-spacing: 0px; font-style: italic;}
        .crit-damage { color: #f6b93b; font-size: 24px; -webkit-text-stroke: 1px #d35400; text-shadow: 0 0 8px rgba(214,100,83,0.6); z-index: 21; }
        .deadly-damage { color: #b784a7; font-size: 32px; -webkit-text-stroke: 1.5px #6f4c65; text-shadow: 0 0 15px rgba(183,132,167,0.8), 2px 2px 0 rgba(0,0,0,0.4); z-index: 22;}
        .auto-dmg-mark { font-size: 13px; opacity:0.9; margin-right:2px; vertical-align:middle; -webkit-text-stroke: 0;}
        
        @keyframes floatHitUp { 
            0%   { opacity: 0; transform: translate(0, 10px) scale(0.5); } 
            15%  { opacity: 1; transform: translate(15px, -20px) scale(1.1); } 
            100% { opacity: 0; transform: translate(45px, -90px) scale(0.7); filter:blur(1px); } 
        }

        #start-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(237, 235, 225, 0.95); display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 10001; }
        #start-overlay .modal { background: #fff; border: 3px solid #ebdcc2; box-shadow: 0 10px 30px rgba(92,83,70,0.1); border-radius: 16px; padding: 30px; max-width: 320px; width: 85%;}
        .ui-input { box-sizing:border-box; width: 100%; padding: 10px; border-radius: 8px; font-size: 16px; margin-bottom: 20px; text-align: center; font-weight: 900; background: #fbfaf5; border: 2px solid #ecd3ac; color: #d48a42;}
        .ui-input::placeholder { color: #ecd3ac; opacity: 0.8;}
    </style>
</head>
<body>

<script>
    // ==============================================================================
    // ğŸ‰ ä¸‡ç•Œå¤©ä¹¦ - è§†è§‰å¼•æ“ / èµ„æºä¸çŸ©é˜µå¸ƒé˜µé…ç½®ä¸­å¿ƒ 
    // ==============================================================================
    window.GameConfig = {
        Visuals: {
            monsterScale: 2.5,         // æ€ªç‰©æ”¾å¤§å€ç‡
            monsterOffsetY: 20,        // æˆ˜å±€æ•´ä½“å¾€ä¸‹åç§»çš„åƒç´ è·ç¦»(å«æ€ªç‰©åŠè¡€æ¡ç­‰æ‰€æœ‰)
            hpBarOffset: 0,           // è¡€æ¡åŸºäºæ€ªç‰©çš„ä¸‹æ”¾æŒ‚è½½è·ç¦»
            summonScale: 3.0,          // å¬å”¤ç‰©æ”¾å¤§å€ç‡
            // ğŸ”¥è‡ªç”±å¸ƒé˜µåæ ‡ç³»ç»Ÿï¼šå¡«å†™æ¯ä¸ªç´¢å¼•ï¼ˆ0å¼€å§‹ï¼Œ0ä¸ºçœŸèº«ï¼‰ç›¸å¯¹ä¸­å¿ƒä½ç½®çš„ xä¸y åç§»åƒç´ å€¼
            summonPositions: [
                {x: -100, y: 30},     // 0: çœŸèº« (å·¦)
                {x: 100,  y: 30},     // 1: å“ªå’ (å³)
                {x: -140, y: 30},  // 2: æ¨æˆ¬ (å·¦)
                {x: 140,  y: 30},  // 3: å­™æ‚Ÿç©º (å³)
                {x: -180, y: 30},   // 4: è§‚éŸ³è©è¨ (å·¦)
                {x: 180,  y: 30}    // 5: å¦‚æ¥ä½›ç¥– (å³)
            ]
        },
        Images: {
            battleBg: "assets/bg.png",   
            goldIcon: "",   
            yaolingIcon: "",
            monsters: [     
                "assets/monster1.png", "assets/monster2.png", "assets/monster3.png", "assets/monster4.png", "assets/monster5.png"  
            ] 
        },
        Settings: {
            baseAttack: 1, baseCritRate: 0, baseCritDmg: 150, baseDeadlyRate: 1, baseDeadlyDmg: 10
        },
        Upgrades: [
            { id: 'dmg', name: "åŸºç¡€æ”»å‡»", icon: "ğŸ—¡ï¸", baseCost: 10,     uStep: 1,   unit: "æ”»", isSummon: false },
            { id: 'cR',  name: "æš´å‡»å‡ ç‡", icon: "ğŸ¯", baseCost: 10,     uStep: 0.1, unit: "%",  isSummon: false },
            { id: 'cD',  name: "æš´å‡»ä¼¤å®³", icon: "ğŸ’¥", baseCost: 10,     uStep: 1,   unit: "%",  isSummon: false },
            { id: 'dd',  name: "è‡´å‘½ä¼¤å®³", icon: "â˜ ï¸", baseCost: 100000, uStep: 1,   unit: "å€", isSummon: false }
        ],
        Summons: [
            { id: 'a0', name: "çœŸèº«",     icon: "ğŸ¤–", img: "assets/jichu.png",  baseCost: 1000,      baseFreq: 20,  freqStep: 2,   isSummon: true },
            { id: 'a1', name: "å“ªå’",     icon: "ğŸ”¥", img: "assets/nezha.png",  baseCost: 10000,     baseFreq: 50,  freqStep: 10,  isSummon: true },
            { id: 'a2', name: "æ¨æˆ¬",     icon: "ğŸ‘ï¸", img: "assets/yangjian.png",  baseCost: 100000,    baseFreq: 100, freqStep: 20,  isSummon: true },
            { id: 'a3', name: "å­™æ‚Ÿç©º",   icon: "ğŸ’", img: "assets/sunwukong.png",  baseCost: 1000000,   baseFreq: 150, freqStep: 30,  isSummon: true },
            { id: 'a4', name: "è§‚éŸ³è©è¨", icon: "ğŸª·", img: "assets/guanyin.png",  baseCost: 10000000,  baseFreq: 250, freqStep: 50,  isSummon: true },
            { id: 'a5', name: "å¦‚æ¥ä½›ç¥–", icon: "â˜¸ï¸", img: "assets/rulai.png",  baseCost: 100000000, baseFreq: 500, freqStep: 100, isSummon: true }
        ],
        Treasures: {
            huntian: { name: "æ··å¤©ç»«", unlockCost: 100,  baseCost: 10,   unlockEff: 10,  unit: "%", desc: "æå‡æš´å‡»å‡ ç‡", color: "#d66453" },
            jingu:   { name: "é‡‘ç®æ£’", unlockCost: 150,  baseCost: 15,   unlockEff: 2,   unit: "%", desc: "æå‡è‡´å‘½å‡ ç‡", color: "#d48a42" },
            sanjian: { name: "ä¸‰å°–ä¸¤åˆƒ", unlockCost: 200,  baseCost: 20,   unlockEff: 100, unit: "%", desc: "æå‡æš´å‡»ä¼¤å®³", color: "#5488a5" },
            yujing:  { name: "ç‰å‡€ç“¶", unlockCost: 300,  baseCost: 30,   unlockEff: 100, unit: "%", desc: "å¢åŠ é‡‘å¸æ‰è½", color: "#5a8a65" },
            lianhua: { name: "è²èŠ±åº§", unlockCost: 500,  baseCost: 50,   unlockEff: 20,  unit: "å€", desc: "æå‡è‡´å‘½ä¼¤å®³", color: "#b784a7" },
            kaitian: { name: "å¼€å¤©æ–§", unlockCost: 1000, baseCost: 100,  unlockEff: 100, unit: "%", desc: "æå‡åŸºç¡€æ”»å‡»", color: "#c45749" },
            qiankun: { name: "ä¹¾å¤åœˆ", unlockCost: 5000, baseCost: 500,  unlockEff: 100, unit: "%", desc: "æå‡è‡ªåŠ¨é¢‘ç‡", color: "#8a6d8c" },
            yuanbao: { name: "ç´«é‡‘é¼", unlockCost: 8000, baseCost: 800,  unlockEff: 500, unit: "%", desc: "å¤§å¹…æå‡é­”å°Šé‡‘å¸", color: "#cc7f22" },
            shengsi: { name: "ç”Ÿæ­»ç°¿", unlockCost: 10000,baseCost: 1000, unlockEff: 100, unit: "%", desc: "æå‡é‡ç”Ÿæ€å¦–çµ", color: "#7f786d" }
        },
        Quests: [
            { id: 0,  desc: "ç‚¹å‡»å‡»è´¥ç¬¬1åªé­”æ€ª",          type: 'stage', target: 2,   reward: 100,       rType: 'gold' },
            { id: 1,  desc: "ä½¿ç”¨é‡‘å¸è§£é”çœŸèº«",          type: 'level', targetK: 'l_a0', target: 1, reward: 1000, rType: 'gold' },
            { id: 2,  desc: "ä½¿ç”¨é‡‘å¸è§£é”å“ªå’",          type: 'level', targetK: 'l_a1', target: 1, reward: 10000, rType: 'gold' },
            { id: 3,  desc: "ä½¿ç”¨é‡‘å¸è§£é”æ¨æˆ¬",          type: 'level', targetK: 'l_a2', target: 1, reward: 100000, rType: 'gold' },
            { id: 4,  desc: "å‡»è´¥é€šå…³ç¬¬10è½®é­”å°Š",        type: 'stage', target: 101, reward: 500000,    rType: 'gold' },
            { id: 5,  desc: "ä½¿ç”¨é‡‘å¸è§£é”å­™æ‚Ÿç©º",        type: 'level', targetK: 'l_a3', target: 1, reward: 1000000, rType: 'gold' },
            { id: 6,  desc: "å®Œæˆç¬¬1æ¬¡é€†å¤©æ”¹å‘½(é‡ç”Ÿ)",    type: 'rebirth',target: 1,   reward: 20,        rType: 'dsp' },
            { id: 7,  desc: "å‡»è´¥é€šå…³ç¬¬12è½®é­”å°Š",        type: 'stage', target: 121, reward: 5000000,   rType: 'gold' },
            { id: 8,  desc: "ä½¿ç”¨é‡‘å¸è§£é”è§‚éŸ³è©è¨",      type: 'level', targetK: 'l_a4', target: 1, reward: 10000000, rType: 'gold' },
            { id: 9,  desc: "å‡»è´¥é€šå…³ç¬¬15è½®é­”å°Š",        type: 'stage', target: 151, reward: 50000000,  rType: 'gold' },
            { id: 10, desc: "ä½¿ç”¨é‡‘å¸è§£é”å¦‚æ¥ä½›ç¥–",      type: 'level', targetK: 'l_a5', target: 1, reward: 100000000, rType: 'gold' },
            { id: 11, desc: "å‡»è´¥é€šå…³ç¬¬20è½®é­”å°Š",        type: 'stage', target: 201, reward: 10000,     rType: 'dsp' },
            { id: 12, desc: "å‡»è´¥é€šå…³ç¬¬25è½®é­”å°Š",        type: 'stage', target: 251, reward: 50000,     rType: 'dsp' },
            { id: 13, desc: "å‡»è´¥é€šå…³ç¬¬30è½®é­”å°Š",        type: 'stage', target: 301, reward: 100000,    rType: 'dsp' },
            { id: 14, desc: "å‡»è´¥é€šå…³ç¬¬40è½®é­”å°Š",        type: 'stage', target: 401, reward: 200000,    rType: 'dsp' },
            { id: 15, desc: "å‡»è´¥é€šå…³ç¬¬50è½®é­”å°Š",        type: 'stage', target: 501, reward: 500000,    rType: 'dsp' },
            { id: 16, desc: "éœ‡ä¸–ï¼æ–©ç­ç¬¬100è½®é­”å°Š",       type: 'stage', target: 1001, reward: 1000000,   rType: 'dsp' }
        ]
    };
</script>

<div id="rebirth-flash"><div class="rebirth-text" id="rebirth-text">é€† å¤© æ”¹ å‘½</div></div>

<div id="start-overlay">
    <h1 style="color:#5a8a65; font-size: 28px; font-weight:900; margin-bottom:8px; letter-spacing: 2px;">æ´ªè’ä»™å½•</h1>
    <h2 style="color:#d48a42; font-size: 14px; margin-top:0; margin-bottom:25px; background:#fff; padding: 2px 10px; border-radius:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">ç ´å¢ƒçœŸä¼ ç‰ˆ</h2>
    <div class="modal">
        <p style="font-size:13px; font-weight:bold; color:#9c9285; margin-bottom:15px;">ç»“ç¼˜é“åŸº</p>
        <input type="text" id="player-name-input" class="ui-input" placeholder="è¾“å…¥å°Šå·..." />
        <button class="upg-act-btn" style="width:100%; padding:12px; font-size:15px; border-radius:10px;" onclick="startGame()">âš”ï¸ å¼€å§‹æ¸¸å†</button>
        <div style="font-size:12px; font-weight:bold; color:#d5ceb8; margin:15px 0;">â€”â€”â€” æˆ– â€”â€”â€”</div>
        <button class="upg-act-btn btn-10x" style="width:100%; padding:10px; font-size:13px; border-radius:10px; background:linear-gradient(180deg,#b5c7b9,#9ab0a2); box-shadow: 0 3px 0 #789e83;" onclick="loadAutoSave()">â±ï¸ è¯»å–è‡ªåŠ¨å­˜æ¡£</button>
        <div style="font-size:12px; font-weight:bold; color:#d5ceb8; margin:15px 0;">â€”â€”â€” æˆ– â€”â€”â€”</div>
        <button class="upg-act-btn btn-10x" style="width:100%; padding:10px; font-size:13px; border-radius:10px; background:linear-gradient(180deg,#d5ceb8,#c2bba7); box-shadow: 0 3px 0 #9c9285;" onclick="document.getElementById('file-import-init').click()">ğŸ“‚ è¯»å–æœ¬åœ°å­˜æ¡£</button>
        <input type="file" id="file-import-init" accept=".json" onchange="importSaveData(event)" style="display:none;" />
    </div>
</div>

<div class="viewport" id="viewport-main">
    <div class="top-panel">
        <div class="header-section">
            <div class="header-name" id="display-name">ã€æœªå‘½åã€‘</div>
            <div style="display:flex; align-items:center;">
                <span id="auto-save-time" style="font-size:10px; color:#b5c7b9; margin-right:4px; font-weight:bold;">æœªå­˜æ¡£</span>
                <button class="save-load-btn" onclick="exportSaveData()">ğŸ’¾</button>
                <button class="save-load-btn" onclick="document.getElementById('file-import-ingame').click()">ğŸ“‚</button>
                <input type="file" id="file-import-ingame" accept=".json" onchange="importSaveData(event)" style="display:none;" />
            </div>
        </div>
        <div class="stats-board">
            <div class="stats-item">æ”»å‡»<span class="sv" id="stat-dmg" style="color:#d48a42">1</span></div>
            <div class="stats-item">è‡ªåŠ¨/åˆ†<span class="sv" id="stat-auto" style="color:#5a8a65">0</span></div>
            <div class="stats-item">æš´ç‡<span class="sv" id="stat-crit-rate" style="color:#e6a143">0%</span></div>
            <div class="stats-item">æš´ä¼¤<span class="sv" id="stat-crit-dmg" style="color:#e6a143">150%</span></div>
            <div class="stats-item">è‡´å‘½ç‡<span class="sv" id="stat-deadly-rate" style="color:#9d698e">1%</span></div>
            <div class="stats-item">è‡´å‘½ä¼¤<span class="sv" id="stat-deadly-dmg" style="color:#9d698e">10x</span></div>
            <div class="stats-item">é€†å¤©æ•°<span class="sv" id="stat-rebirths-main" style="color:#5488a5">0</span></div>
            <div class="stats-item">å¦–çµ<span class="sv" id="stat-dsp-main" style="color:#218c74">0</span></div>
        </div>
    </div>
        
    <div class="monster-area" id="monster-area">
        <div class="stage-info">
            <span id="stage-info-text">ç¬¬ 1 è½® - æå° 1</span>
            <span class="boss-timer" id="boss-timer-wrap">(<span id="timer-text">90</span>s)</span>
        </div>
        <div class="gold-display" id="top-gold-display"></div>
        
        <div class="battle-stage" id="battle-stage">
            <div id="avatars-container"></div>
            <div class="monster-wrapper" id="monster-wrapper" onclick="attackHnd(event)">
                <div class="monster" id="monster">ğŸ‘¾</div>
            </div>
            
            <div class="hp-bar-container"><div class="hp-bar" id="hp-bar"></div><div class="hp-text"><span id="hp-current">10</span> / <span id="hp-max">10</span></div></div>
        </div>
        <button class="challenge-btn" id="btn-challenge" onclick="challengeBoss()">è®¨ä¼é€†å¿ƒ</button>
    </div>

    <div class="scroll-panel">
        <div id="tab-upgrades" class="tab-content active">
            <div class="upgrades" id="upgrades-dom"></div>
        </div>
        <div id="tab-treasures" class="tab-content">
            <div class="treasure-header">ğŸ’ é™å¦–æ³•å®å›¾å½•</div>
            <div class="treasure-grid" id="treasure-grid"></div>
        </div>
        <div id="tab-quests" class="tab-content"><div id="quest-list"></div></div>
        <div id="tab-rebirth" class="tab-content">
            <div class="rebirth-area">
                <p style="color:#d48a42; font-weight:900; font-size:14px; margin:0 0 8px 0;">é€ åŒ–å¦–çµå‡æ·¬</p>
                <div style="font-size:36px; color:#5a8a65; font-weight:900; text-shadow:0 1px 0px rgba(255,255,255,1); margin-bottom:12px;"><span id="current-rebirth-points">0</span></div>
                <div id="rebirth-lock-text" style="color:#d66453; font-size:11px; margin-bottom:12px; font-weight:bold;">è‡³ç¬¬10è½®é­”å°Šæ–¹å¯é‡å¡‘ï¼ç°å¤„äº:ç¬¬<span id="r-lock-stage">1</span>è½®</div>
                <button class="rebirth-btn" id="btn-rebirth" onclick="doRebirth(false)" disabled>é€†å¤©æ”¹å‘½</button>
            </div>
            <div class="auto-compact-bar">
                <div style="display:flex; align-items:center; justify-content:center; gap:4px; width:100%;">
                    <span style="color:#d48a42; font-weight:bold; font-size:12px;">æ‰“è½ç¬¬</span>
                    <input type="number" id="auto-stage-input" class="auto-input" min="10" value="10" />
                    <span style="color:#d48a42; font-weight:bold; font-size:12px;">è½®åè‡ªåŠ¨è½®å›</span>
                    <button class="auto-btn" id="btn-toggle-auto" onclick="toggleAutoRebirth()" style="margin-left:auto;">å¯ç”¨</button>
                </div>
            </div>
        </div>
        <div id="tab-leaderboard" class="tab-content">
            <div class="lb-title">ğŸ‘‘ ä¸‡ç•Œå¤©æ¦œ (ç¥é˜¶åˆ¶)</div>
            <div class="lb-list" id="lb-list"></div>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" id="nav-upgrades" onclick="switchTab('upgrades')"><div class="tab-icon">ğŸ“˜</div><div>ä¿®çœŸ</div></div>
        <div class="tab-item" id="nav-treasures" onclick="switchTab('treasures')"><div class="tab-icon">ğŸ’</div><div>æ³•å®</div></div>
        <div class="tab-item" id="nav-quests" onclick="switchTab('quests')"><div class="tab-icon">ğŸ“œ</div><div>æ‚¬èµ</div></div>
        <div class="tab-item" id="nav-rebirth" onclick="switchTab('rebirth')"><div class="tab-icon">ğŸ”„</div><div>æ”¹å‘½</div></div>
        <div class="tab-item" id="nav-leaderboard" onclick="switchTab('leaderboard')"><div class="tab-icon">ğŸ†</div><div>å¤©æ¦œ</div></div>
    </div>
</div>

<script>
    function getResIcon(type, size = 16) {
        if(type === 'gold') {
            if(GameConfig.Images.goldIcon) return `<div style="display:inline-block;width:${size}px;height:${size}px;background:url('${GameConfig.Images.goldIcon}') center/contain no-repeat;vertical-align:middle;margin:0 2px;"></div>`;
            return `<span class="gold-icon">é‡‘</span>`;
        } else {
            if(GameConfig.Images.yaolingIcon) return `<div style="display:inline-block;width:${size}px;height:${size}px;background:url('${GameConfig.Images.yaolingIcon}') center/contain no-repeat;vertical-align:middle;margin:0 2px;"></div>`;
            return `<span class="dsp-icon">çµ</span>`;
        }
    }

    const GLD_UI = getResIcon('gold', 14);
    const YL_UI = getResIcon('yaoling', 14);

    function applyVisualConfig() {
        let vc = GameConfig.Visuals || { monsterScale: 1.5, monsterOffsetY: 80, hpBarOffset: 40, summonScale: 2.0, summonPositions: [] };
        let styleStr = `
            :root { 
                --m-scale: ${vc.monsterScale}; 
                --s-scale: ${vc.summonScale}; 
                --m-offset-y: ${vc.monsterOffsetY || 80}px; 
            }
            .battle-stage { transform: translateY(var(--m-offset-y)); }
            .monster-wrapper { width: calc(85px * var(--m-scale)); height: calc(85px * var(--m-scale)); }
            .monster-wrapper::after { width: calc(70px * var(--m-scale)); bottom: calc(-12px * var(--m-scale)); height: calc(14px * var(--m-scale));}
            .monster { font-size: calc(50px * var(--m-scale)); border-width: calc(2px * var(--m-scale));}
            .monster-ghost { font-size: calc(50px * var(--m-scale)); }
            .hp-bar-container { margin-top: ${Math.max(10, 25 + vc.hpBarOffset)}px !important; }
        `;
        let sEl = document.getElementById('dynamic-visual-style');
        if(!sEl) { sEl = document.createElement('style'); sEl.id = 'dynamic-visual-style'; document.head.appendChild(sEl); }
        sEl.innerHTML = styleStr;
    }

    function buildDynamicUI() {
        applyVisualConfig();
        document.getElementById('top-gold-display').innerHTML = `${getResIcon('gold', 16)} <span id="gold">0</span>`;

        let vc = GameConfig.Visuals;
        let sScale = vc.summonScale;
        let posArr = vc.summonPositions || [];
        
        let avH = '';
        GameConfig.Summons.forEach((s, i) => {
            let pos = posArr[i] || {x: (i%2===0?-1:1)*80*(Math.floor(i/2)+1), y: 0};
            let imgStr = s.img ? `background-image:url('${s.img}'); background-size:contain; background-position:center; background-repeat:no-repeat; width: ${1.5 * sScale}em; height: ${1.5 * sScale}em;` : `font-size: ${24 * sScale}px;`;
            let sText = s.img ? '' : s.icon; 
            avH += `<div id="ava-${s.id}" class="avatar" style="left: calc(50% + ${pos.x}px); top: calc(50% + ${pos.y}px); ${imgStr}">${sText}</div>`;
        });
        document.getElementById('avatars-container').innerHTML = avH;
        if(GameConfig.Images.battleBg) document.getElementById('monster-area').style.backgroundImage = `url('${GameConfig.Images.battleBg}')`;

        let bCore = '';
        const makeCard = (u) => {
            let lvIcon = `<span class="lvl-badge" id="lvl-${u.id}">Lv.0</span>`;
            let cardTitIcon = u.img ? '' : u.icon;
            let watermark = (u.isSummon && u.img) ? `<div class="summon-watermark" style="background-image:url('${u.img}')"></div>` : '';
            return `
            <div class="upg-item" id="upg-ui-${u.id}">
                ${watermark}
                <div class="title-row"><span>${lvIcon} ${cardTitIcon} ${u.name}</span></div>
                <div class="desc-row" id="desc-${u.id}"></div>
                <div class="upg-actions">
                    <button class="upg-act-btn" id="btn-${u.id}-1" onclick="buyStateUpg('${u.id}',1)">
                        <span>Ã—1</span><div style="display:flex;align-items:center;opacity:0.95;">${GLD_UI} <span id="cost-${u.id}-1" style="margin-left:2px;"></span></div>
                    </button>
                    ${!u.isSummon ? `
                    <button class="upg-act-btn btn-10x" id="btn-${u.id}-10" onclick="buyStateUpg('${u.id}',10)">
                        <span>Ã—10</span><div style="display:flex;align-items:center;opacity:0.95;">${GLD_UI} <span id="cost-${u.id}-10" style="margin-left:2px;"></span></div>
                    </button>` 
                    : `
                    <button class="upg-act-btn btn-10x" id="btn-${u.id}-10" style="display:none;" onclick="buyStateUpg('${u.id}',10)">
                        <span>Ã—10</span><div style="display:flex;align-items:center;opacity:0.95;">${GLD_UI} <span id="cost-${u.id}-10" style="margin-left:2px;"></span></div>
                    </button>`}
                </div>
            </div>`;
        };
        GameConfig.Upgrades.forEach(u => bCore += makeCard(u));
        GameConfig.Summons.forEach(s => bCore += makeCard(s));
        document.getElementById('upgrades-dom').innerHTML = bCore;

        let qHtml = ''; GameConfig.Quests.forEach((q) => {
            let rText = q.rType === 'dsp' ? YL_UI : GLD_UI;
            qHtml += `<div class="quest-item"><span style="font-size:12px;font-weight:900;color:#5c5346;">[å†ç»ƒ-${q.id+1}] ${q.desc}<br><small style="color:#789e83;">(èµ: ${rText} <span style="color:#d48a42;font-weight:900;">${f(q.reward)}</span>)</small></span><button id="btn-quest-${q.id}" class="btn-claim" disabled>æ½œä¿®ä¸­</button></div>`;
        }); document.getElementById('quest-list').innerHTML = qHtml;

        GameConfig.Upgrades.forEach(u => { csMap[u.id] = 'c_'+u.id; });
        GameConfig.Summons.forEach(s => { csMap[s.id] = 'c_'+s.id; });
    }

    let currentTabId = 'upgrades';
    function f(n){if(!n||n===0)return"0";if(n<0)return"-"+f(-n);if(n>=1e16)return parseFloat(n).toExponential(2);if(n>=1e12)return parseFloat((n/1e12).toFixed(2))+"å…†";if(n>=1e8)return parseFloat((n/1e8).toFixed(2))+"äº¿";if(n>=1e4)return parseFloat((n/10000).toFixed(2))+"ä¸‡";if(Number.isInteger(n))return n.toString();return parseFloat(n.toFixed(2));}

    let state = { name: "", gold: 0, maxStage: 1, cStage: 1, hpMax: 10, hpCurrent: 10, dmg: GameConfig.Settings.baseAttack, critR: GameConfig.Settings.baseCritRate, critD: GameConfig.Settings.baseCritDmg, deadlyD: GameConfig.Settings.baseDeadlyDmg, quests: Array(GameConfig.Quests.length).fill(0), rebirthCount: 0, dsp: 0, pendingDsp: 0, t_huntian:0, t_jingu:0, t_sanjian:0, t_yujing:0, t_lianhua:0, t_kaitian:0, t_qiankun:0, t_yuanbao:0, t_shengsi:0, lbBots: null };
    let csMap = {};

    let isAutoRebirth = false, needUIUpdate = false, isRebirthing = false;
    let pendingShouldPlayDeath = false, sn_emoji = "", sn_color = "", sn_img = "", sn_boss = false;
    let isBoss = false, bossExpireTime = 0, lastLogicTick = Date.now(), autoAttackAccumulator = 0;
    const mythicNames = ['é¥•é¤®','ç©·å¥‡','æ¢¼æŒ','æ··æ²Œ','ç™½æ³½','éº’éºŸ','å‡¤å‡°','ä¹å°¾ç‹','æ¯•æ–¹','é‡æ˜é¸Ÿ','è ƒé±¼','é’é¾™','ç™½è™','æœ±é›€','ç„æ­¦','åŒ–è›‡','ä¹å©´'];
    const emojis = ['ğŸ‘¾','ğŸ‘½','ğŸ¢','ğŸ‰','ğŸ²','ğŸ¦…','ğŸ¦','ğŸ','ğŸ¦‡','ğŸŒ‹','ğŸ‘º','ğŸ‘¹','ğŸ¦–','ğŸ¦‘'];
    const hpCache = {1:10};

    function getStageHp(st) { if(hpCache[st])return hpCache[st]; for(let i=2; i<=st; i++){ if(!hpCache[i]) hpCache[i] = Math.ceil(hpCache[i-1]*1.1); } return hpCache[st]; }
    function Ce(v) { return Math.ceil(v); }
    
    function getTreasureEff(id) { let lv=state['t_'+id]||0; if(lv===0)return 0; return GameConfig.Treasures[id].unlockEff + (lv-1)*(GameConfig.Treasures[id].unlockEff*0.01); }
    function getTreasureUpgCost(id, cLv, n) { let d=GameConfig.Treasures[id], t=0, lv=cLv; for(let i=0;i<n;i++){ t += lv===0 ? d.unlockCost : d.baseCost*Math.pow(2, Math.floor(lv/100)); lv++; } return t; }
    
    function getActualCR() { return parseFloat((state.critR+getTreasureEff('huntian')).toFixed(3)); }
    function getActualCD() { return parseFloat((state.critD+getTreasureEff('sanjian')).toFixed(3)); }
    function getActualDR() { return parseFloat((GameConfig.Settings.baseDeadlyRate + getTreasureEff('jingu')).toFixed(3)); }
    function getActualDD() { return parseFloat((state.deadlyD+getTreasureEff('lianhua')).toFixed(3)); }
    function getActualAtkMult() { return 1+getTreasureEff('kaitian')/100; }
    function getActualCoinMult() { return 1+getTreasureEff('yujing')/100; }

    function switchTab(tb) { document.querySelectorAll('.tab-content,.tab-item').forEach(e=>e.classList.remove('active')); document.getElementById(`tab-${tb}`).classList.add('active'); document.getElementById(`nav-${tb}`).classList.add('active'); currentTabId=tb; if(tb==='leaderboard')renderLeaderboard(); }
    
    function generateBots() { if(state.lbBots)return; state.lbBots=[]; let p1=["å¢¨æ¸Š","äº‘è™š","åŒ–æ¢¦","é€é¥","æ— æ","é’äº‘","ç„éœœ","ç‚½é˜³","å¤ªå¾®","æ··æ²Œ"]; let p2=["å‰‘ç‹","æ˜Ÿä¸»","é“å›","å¦–çš‡","æ•£ä»™","è¡Œè€…","å°Šè€…","åœ£ç«¥"]; for(let i=0;i<99;i++) state.lbBots.push({name: p1[i%p1.length]+p2[i%p2.length], round: Math.floor(Math.random()*135)+15}); state.lbBots[0]={name:"å¤©é“é¸¿é’§", round:150}; }
    function renderLeaderboard() {
        let all = [...state.lbBots, {name: state.name||"é“ç¥–", round: Math.ceil(state.maxStage/10), isP: true}].sort((a,b)=>b.round-a.round);
        document.getElementById('lb-list').innerHTML = all.slice(0,100).map((it, i) => `<div class="lb-item ${i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':''} ${it.isP?'is-player':''}"><div class="lb-rank">${i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`No.${i+1}`}</div><div class="lb-name">${it.name}${it.isP?" (ä½ )":""}</div><div class="lb-round">å‡»è´¥ ${it.round} è½®é­”å°Š</div></div>`).join('');
    }

    function startGame() { state.name = document.getElementById('player-name-input').value.trim() || "æ— åé“ç¥–"; finalizeLoad(); }
    function exportSaveData() { let dl = document.createElement('a'); dl.setAttribute("href", "data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(state))); dl.setAttribute("download", `${state.name}_ç ´é˜µæ®‹å·.json`); document.body.appendChild(dl); dl.click(); dl.remove(); }
    function importSaveData(evt) { let f_ = event.target.files[0]; if(!f_)return; let r = new FileReader(); r.onload = e => { try { Object.assign(state, JSON.parse(e.target.result)); while(state.quests.length<GameConfig.Quests.length) state.quests.push(0); finalizeLoad(); }catch(ex){alert("é“å°æŸæ¯ï¼");}}; r.readAsText(f_); }
    function loadAutoSave() { let s = localStorage.getItem('shuxian_pj_save'); if(s) { Object.assign(state, JSON.parse(s)); while(state.quests.length<GameConfig.Quests.length) state.quests.push(0); finalizeLoad(); } else alert("æœªçª¥è§ä»»ä½•é“å¿ƒæ®‹ç•™ã€‚"); }
    setInterval(() => { if(state.name){ localStorage.setItem('shuxian_pj_save', JSON.stringify(state)); let d=new Date(); document.getElementById('auto-save-time').innerText="è‡ªåŠ¨å­˜æ¡£ "+d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0'); } }, 60000);

    function finalizeLoad() {
        GameConfig.Upgrades.forEach(u => { let ck = 'c_'+u.id; if(state['l_'+u.id] == null) state['l_'+u.id]=0; if(state[ck] == null || isNaN(state[ck])) state[ck] = u.baseCost; });
        GameConfig.Summons.forEach(s => { let ck = 'c_'+s.id; if(state['l_'+s.id] == null) state['l_'+s.id]=0; if(state[ck] == null || isNaN(state[ck])) state[ck] = s.baseCost; });
        
        buildDynamicUI(); generateBots(); initTreasuresDOM(); spawnMonster(state.cStage, true);
        document.getElementById('start-overlay').style.display='none';
        
        document.getElementById('display-name').innerText = `${state.name}çš„æ´ªè’å†`;
        lastLogicTick = Date.now(); updateUI(); fastSyncMonsterUI(); uiSyncAutoMode();
    }

    function toggleAutoRebirth() { 
        let inp = document.getElementById('auto-stage-input');
        if(!isAutoRebirth && parseInt(inp.value)<10) { alert("è‡³å°‘æ‰“è½10è½®æ–¹å¯ç«‹åŠ«"); return; }
        isAutoRebirth = !isAutoRebirth; inp.disabled = isAutoRebirth;
        document.getElementById('btn-toggle-auto').className = `auto-btn ${isAutoRebirth?'active':''}`;
        document.getElementById('btn-toggle-auto').innerText = isAutoRebirth?"ğŸ›‘ æŒ‚æœºä¸­":"å¯ç”¨";
        if(isAutoRebirth) processAutoUpg(); uiSyncAutoMode();
    }
    
    function uiSyncAutoMode() { document.querySelectorAll('.upg-item').forEach(el=> el.parentElement.id.includes('upgrades') ? el.classList.toggle('disabled-in-auto', isAutoRebirth) : null); updateUI(); }

    function applyUpgradeMath(id, step) {
        if(id==='dmg'){ state.dmg += Math.pow(2, Math.floor(state['l_'+id]/20)); }
        else if(id==='cR'){ state.critR += step; } else if(id==='cD'){ state.critD += step; } else if(id==='dd'){ state.deadlyD += step; }
        state['l_'+id]++;
    }

    function processAutoUpg() {
        if(!isAutoRebirth || isRebirthing) return;
        let bought=true, breaker=10000; let cKeys = [...GameConfig.Upgrades, ...GameConfig.Summons];
        while(bought && breaker-->0) { bought = false; cKeys.forEach(cfg => { let c = state[csMap[cfg.id]]; if(state.gold >= c) { state.gold -= c; if(GameConfig.Summons.some(s=>s.id===cfg.id)) state['l_'+cfg.id]++; else applyUpgradeMath(cfg.id, cfg.uStep); state[csMap[cfg.id]] = (cfg.id==='dd') ? c*2 : Ce(c*1.1); bought=true; } });
        } needUIUpdate=true;
    }

    function getUpgCostRange(id, n) { let c=state[csMap[id]], sum=0; for(let i=0;i<n;i++) { sum+=c; c = id==='dd'?c*2:Ce(c*1.1); } return sum; }
    
    function buyStateUpg(id, n) {
        let cost = getUpgCostRange(id, n);
        if(state.gold >= cost) { state.gold -= cost; let isS = GameConfig.Summons.some(s=>s.id===id); let uCfg = isS ? null : GameConfig.Upgrades.find(u=>u.id===id);
            for(let i=0;i<n;i++) { if(isS) state['l_'+id]++; else applyUpgradeMath(id, uCfg.uStep); state[csMap[id]] = (id==='dd') ? state[csMap[id]]*2 : Ce(state[csMap[id]]*1.1); } updateUI();
        }
    }

    function processQuests() {
        GameConfig.Quests.forEach(q => {
            let passed = false; if(q.type==='stage') passed = state.maxStage >= q.target; else if(q.type==='level') passed = state[q.targetK] >= q.target; else if(q.type==='rebirth') passed = state.rebirthCount >= q.target;
            if (state.quests[q.id] === 0 && passed) state.quests[q.id] = 1; let b = document.getElementById(`btn-quest-${q.id}`); if(!b) return;
            if(state.quests[q.id]===0) { b.className="btn-claim"; b.disabled=true; b.innerText="å†ç‚¼ä¸­"; b.onclick=null;}
            else if(state.quests[q.id]===1) { b.className="btn-claim active"; b.disabled=false; b.innerText="ğŸé¢†å–"; b.onclick=()=>claimQuest(q.id); }
            else { b.className="btn-claim done"; b.disabled=true; b.innerText="âœ…ç ´å¢ƒ"; b.onclick=null; }
        });
    }
    
    function claimQuest(id) { let q = GameConfig.Quests.find(x=>x.id===id); if(state.quests[id] === 1) { if(q.rType==='gold') state.gold += q.reward; if(q.rType==='dsp') state.dsp += q.reward; state.quests[id]=2; needUIUpdate=true; if(isAutoRebirth) processAutoUpg(); } }

    function initTreasuresDOM() {
        let h=''; Object.entries(GameConfig.Treasures).forEach(([id, d]) => { 
            h += `
            <div class="treasure-item locked" id="tb-${id}">
                <strong style="color:${d.color};font-size:13px;border-bottom:1px dotted #e8e3d8;padding-bottom:4px;">${d.name} <span id="tb-lv-${id}" style="color:#f6b93b;font-size:11px;"></span></strong>
                <span style="color:#9c9285;font-size:11px;margin:5px 0;">${d.desc} <strong id="tb-eff-${id}" style="color:#5a8a65;">+0</strong><br><span id="tb-next-${id}" style="font-size:10px;color:#b5c7b9;"></span></span>
                <div class="t-actions upg-actions">
                    <button class="upg-act-btn" id="btn-t1-${id}" onclick="buyTreasure('${id}',1)"></button>
                    <button class="upg-act-btn btn-10x" id="btn-t10-${id}" style="display:none;" onclick="buyTreasure('${id}',10)"></button>
                </div>
            </div>`;
        }); document.getElementById('treasure-grid').innerHTML=h;
    }
    function updateTreasuresUI() {
        Object.entries(GameConfig.Treasures).forEach(([id, d]) => {
            let lv=state['t_'+id]||0, c1=getTreasureUpgCost(id,lv,1), c10=getTreasureUpgCost(id,lv,10), el=document.getElementById(`tb-${id}`);
            el.className=`treasure-item ${lv>0?'owned':'locked'}`; document.getElementById(`tb-lv-${id}`).innerText=lv>0?`Lv.${lv}`:"";
            document.getElementById(`tb-eff-${id}`).innerText=`+${parseFloat(getTreasureEff(id).toFixed(2))}${d.unit}`;
            document.getElementById(`tb-next-${id}`).innerText=`(ä¸‹ä¸€çº§: +${parseFloat((lv===0?d.unlockEff:(d.unlockEff+lv*(d.unlockEff*0.01))).toFixed(2))}${d.unit})`;
            let b1=document.getElementById(`btn-t1-${id}`), b10=document.getElementById(`btn-t10-${id}`);
            b1.disabled=(state.dsp<c1); b10.disabled=(state.dsp<c10); 
            if(lv===0){ 
                b1.style.display='flex';b10.style.display='none'; 
                b1.innerHTML=`<span>Ã—1</span><div style="display:flex;align-items:center;opacity:0.95;">${YL_UI} <span style="margin-left:2px;">${f(c1)}</span></div>`; 
            } else { 
                b1.style.display='flex';b10.style.display='flex'; 
                b1.innerHTML=`<span>Ã—1</span><div style="display:flex;align-items:center;opacity:0.95;">${YL_UI} <span style="margin-left:2px;">${f(c1)}</span></div>`; 
                b10.innerHTML=`<span>Ã—10</span><div style="display:flex;align-items:center;opacity:0.95;">${YL_UI} <span style="margin-left:2px;">${f(c10)}</span></div>`; 
            }
        });
    }
    function buyTreasure(id,n) { let lv=state['t_'+id]||0,c=getTreasureUpgCost(id,lv,n); if(state.dsp>=c){state.dsp-=c;state['t_'+id]=lv+n;updateUI();} }

    function playRebirthAnimation() { return new Promise(r=>{ let fl=document.getElementById('rebirth-flash'),tx=document.getElementById('rebirth-text'),vp=document.getElementById('viewport-main'); fl.style.display='flex';void fl.offsetWidth;fl.style.opacity='1';tx.style.opacity='1';tx.style.transform='scale(1)'; setTimeout(()=>{ vp.style.opacity='0';r(); setTimeout(()=>{ fl.style.opacity='0';tx.style.opacity='0';tx.style.transform='scale(0.2)';vp.style.opacity='1'; setTimeout(()=>fl.style.display='none',800); },1000);},600); }); }
    async function doRebirth(skip=false) { if(isRebirthing)return; let g=Ce(state.pendingDsp||0); if(!skip&&!confirm(`ã€å¤§é“è½®å›Â·é‡ç‡ƒçœŸèº«ã€‘\nä¸‡ç•Œçµæ°”ä¿±æ•£ï¼\næ­¤ç•ªæ·¬ç‚¼å¯èšï¼š${f(g)} ç‚¹å¦–çµã€‚\næ­¥å…¥è½®å›é€šé“ï¼Ÿ`))return; isRebirthing=true; await playRebirthAnimation(); state.dsp+=g; state.pendingDsp=0; state.rebirthCount++; state.cStage=1; state.maxStage=1; state.dmg=GameConfig.Settings.baseAttack; state.critR=GameConfig.Settings.baseCritRate; state.critD=GameConfig.Settings.baseCritDmg; state.deadlyD=GameConfig.Settings.baseDeadlyDmg; GameConfig.Upgrades.forEach(u=>{ state['l_'+u.id]=0; state['c_'+u.id]=u.baseCost; }); GameConfig.Summons.forEach(s=>{ state['l_'+s.id]=0; state['c_'+s.id]=s.baseCost; }); state.gold=Ce(1000000*getActualCoinMult()); spawnMonster(state.cStage,true); isRebirthing=false; if(isAutoRebirth)processAutoUpg(); updateUI(); }

    const elM = document.getElementById('monster'), elWrap = document.getElementById('monster-wrapper');
    function triggerHitAnim() { elM.classList.remove('hit'); void elM.offsetWidth; elM.classList.add('hit'); }
    function executeDeathAndSpawnVisuals() { 
        if(document.visibilityState !=='visible'||isRebirthing)return; 
        let g=document.createElement('div'); g.className='monster-ghost'; if(sn_boss)g.classList.add('boss');
        if(sn_img && sn_img !== "none") { g.style.background = sn_img; g.style.border="none"; g.style.boxShadow="none"; } else { g.style.background=sn_color; g.innerText=sn_emoji; }
        
        // â­å®Œç¾ä¿®å¤æ®‹åƒä½“ç§¯æåº¦è†¨èƒ€ï¼šæŒ‚è½½ç›®æ ‡ä¿®æ­£ä¸ºå…¶çœŸæ­£çš„ç‰©ç†å¤§å°çˆ¶çº§
        elWrap.appendChild(g); setTimeout(()=>g.remove(),350);
        
        elM.classList.remove('spawn'); void elM.offsetWidth; elM.classList.add('spawn');
        setTimeout(()=>{ let dl=document.createElement('div');dl.className='dust-l'; let dr=document.createElement('div');dr.className='dust-r'; elWrap.appendChild(dl);elWrap.appendChild(dr); setTimeout(()=>{dl.remove();dr.remove();},400);},180);
        setTimeout(()=>elM.classList.remove('spawn'),450);
    }

    function getTotalAutoRate() { let t = 0; GameConfig.Summons.forEach(s => { if(state['l_'+s.id]>0) t += s.baseFreq + (state['l_'+s.id]-1)*s.freqStep; }); return Ce(t*(1+getTreasureEff('qiankun')/100)); }

    setInterval(()=>{ let n=Date.now(),dt=n-lastLogicTick; lastLogicTick=n; if(isRebirthing)return;
        if(isBoss&&bossExpireTime>0){ let ls=Math.ceil((bossExpireTime-n)/1000); if(ls<=0){bossExpireTime=0;state.cStage--;spawnMonster(state.cStage,true);} else document.getElementById('timer-text').innerText=ls; }
        let tr = getTotalAutoRate();
        if(tr>=1800) {
            let ea=(tr/60000)*dt, aCR=getActualCR(),aCD=getActualCD(),aDR=getActualDR(),aDD=getActualDD(), bd=Ce(state.dmg*getActualAtkMult());
            let avg=Ce(bd*(1-(aCR/100)+(aCR/100)*(aCD/100))*(1-(aDR/100)+(aDR/100)*aDD)), dp=Ce(ea*avg); if(dp>99999999)dp=Math.floor(dp/10000)*10000;
            let ka=false, sd=dp, sf=false;
            while(dp>0 && state.hpCurrent>0) {
                if(dp>=state.hpCurrent) {
                    dp-=state.hpCurrent;state.hpCurrent=0;ka=true; let cm=getActualCoinMult(), rnd=Math.ceil(state.cStage/10), dm=rnd<5?1:(Math.floor(rnd/5)+1);
                    state.pendingDsp += Ce((isBoss?3:1)*dm*(1+getTreasureEff('shengsi')/100));
                    if(isBoss){ state.gold+=Ce((state.hpMax*3)*cm*(1+getTreasureEff('yuanbao')/100)); bossExpireTime=0; if(isAutoRebirth&&rnd===parseInt(document.getElementById('auto-stage-input').value)) {sf=true;break;} } else state.gold+=Ce(state.hpMax*cm);
                    if(!pendingShouldPlayDeath&&document.visibilityState==='visible'){ sn_emoji=elM.innerText;sn_color=elM.style.background;sn_img=elM.style.backgroundImage!==''?elM.style.backgroundImage:'none'; sn_boss=elM.classList.contains('boss'); pendingShouldPlayDeath=true;}
                    if(state.cStage===state.maxStage)state.maxStage++; state.cStage++; isBoss=(((state.cStage-1)%10+1)===10); state.hpMax=getStageHp(state.cStage); state.hpCurrent=state.hpMax;
                } else { state.hpCurrent-=dp;dp=0; }
            }
            if(sd>0||ka)needUIUpdate=true;
            if(sd>0&&document.visibilityState==='visible'){triggerHitAnim();const r=elM.getBoundingClientRect();buildFloatDmg(r.left+r.width/2,r.top,sd,'deadly',true);}
            if(sf)doRebirth(true); else if(ka&&isAutoRebirth)processAutoUpg();
        } else if(tr>0) { autoAttackAccumulator += (tr/60000)*dt; if(autoAttackAccumulator>=1){ let c=Math.floor(autoAttackAccumulator); autoAttackAccumulator-=c; batchSimulate(c); } }
        if(needUIUpdate) { updateUI(); fastSyncMonsterUI(); if(currentTabId==='leaderboard')renderLeaderboard(); needUIUpdate=false; }
        if(pendingShouldPlayDeath) { executeDeathAndSpawnVisuals(); pendingShouldPlayDeath=false; }
    }, 100);

    function buildFloatDmg(x,y,dmg,type,isAuto){ 
        let d=document.createElement('div'); d.className='floating-damage'; 
        let mk=isAuto?`<span class="auto-dmg-mark">ğŸ¤–</span>`:''; 
        if(type==='deadly'){d.classList.add('deadly-damage');d.innerHTML=`${mk}â˜ ï¸ -${f(Ce(dmg))}`;}else if(type==='crit'){d.classList.add('crit-damage');d.innerHTML=`${mk}ğŸ’¥ -${f(Ce(dmg))}`;}else{d.innerHTML=`${mk}-${f(Ce(dmg))}`;} 
        let r=(Math.random()-0.5)*30; let areaRect=document.getElementById('monster-area').getBoundingClientRect(); 
        d.style.left=(x - areaRect.left + r)+'px'; d.style.top=(y - areaRect.top - 15)+'px'; 
        document.getElementById('monster-area').appendChild(d); setTimeout(()=>d.remove(),800); 
    }

    function batchSimulate(c) {
        let aCR=getActualCR(),aCD=getActualCD(),aDR=getActualDR(),aDD=getActualDD(),bd=Ce(state.dmg*getActualAtkMult()), aL=c, bt=0, anyC=false, anyD=false;
        while(aL>0 && state.hpCurrent>0) {
            if(aL<50){ let isC=(Math.random()*100)<aCR, isD=(Math.random()*100)<aDR, fd=bd; if(isC){fd=Ce(fd*(aCD/100));anyC=true;} if(isD){fd=Ce(fd*aDD);anyD=true;} if(fd>99999999)fd=Math.floor(fd/10000)*10000; state.hpCurrent-=fd; bt+=fd; aL--; if(state.hpCurrent<=0) fastDefeatHandling(); }
            else{ let ev=Ce(bd*(1-(aCR/100)+(aCR/100)*(aCD/100))*(1-(aDR/100)+(aDR/100)*aDD)); if(ev>99999999)ev=Math.floor(ev/10000)*10000; let hk=Math.ceil(state.hpCurrent/Math.max(1,ev)); if(hk<=aL){bt+=state.hpCurrent;aL-=hk;state.hpCurrent=0;anyC=true;fastDefeatHandling();} else{state.hpCurrent-=(ev*aL);bt+=(ev*aL);anyC=true;aL=0;} }
        }
        if(bt>0&&document.visibilityState==='visible'){triggerHitAnim();let r=elM.getBoundingClientRect();buildFloatDmg(r.left+r.width/2,r.top,bt,anyD?'deadly':(anyC?'crit':'normal'),true);} needUIUpdate=true;
    }

    function fastDefeatHandling(){ let rnd=Math.ceil(state.cStage/10); state.pendingDsp+=Ce((isBoss?3:1)*(rnd<5?1:Math.floor(rnd/5)+1)*(1+getTreasureEff('shengsi')/100)); if(!pendingShouldPlayDeath&&document.visibilityState==='visible'){sn_emoji=elM.innerText;sn_color=elM.style.background;sn_img=elM.style.backgroundImage!==''?elM.style.backgroundImage:'none'; sn_boss=elM.classList.contains('boss');pendingShouldPlayDeath=true;} let cm=getActualCoinMult(); if(isBoss){state.gold+=Ce((state.hpMax*3)*cm*(1+getTreasureEff('yuanbao')/100));bossExpireTime=0;}else state.gold+=Ce(state.hpMax*cm); if(state.cStage===state.maxStage)state.maxStage++;state.cStage++; if(isAutoRebirth){processAutoUpg();if(isBoss&&rnd===parseInt(document.getElementById('auto-stage-input').value)){doRebirth(true);return;}} isBoss=(((state.cStage-1)%10+1)===10);state.hpMax=getStageHp(state.cStage);state.hpCurrent=state.hpMax; }

    function attackHnd(e) { if(state.hpCurrent<=0||isRebirthing)return; triggerHitAnim(); let isC=(Math.random()*100)<getActualCR(),isD=(Math.random()*100)<getActualDR(),fd=Ce(state.dmg*getActualAtkMult()); if(isC)fd=Ce(fd*(getActualCD()/100)); if(isD)fd=Ce(fd*getActualDD()); if(fd>99999999)fd=Math.floor(fd/10000)*10000; state.hpCurrent-=fd; let t='normal';if(isD)t='deadly';else if(isC)t='crit'; buildFloatDmg(e.clientX,e.clientY,fd,t,false); if(state.hpCurrent<=0)fastDefeatHandling(); updateUI();fastSyncMonsterUI();needUIUpdate=false; if(pendingShouldPlayDeath){executeDeathAndSpawnVisuals();pendingShouldPlayDeath=false;} }

    function updateUI() {
        processQuests(); updateTreasuresUI();
        document.getElementById('gold').innerText=f(state.gold);
        document.getElementById('stat-dmg').innerText=f(Ce(state.dmg*getActualAtkMult()));
        document.getElementById('stat-auto').innerText=f(Ce(getTotalAutoRate()));
        document.getElementById('stat-crit-rate').innerText=getActualCR().toFixed(1)+"%";
        document.getElementById('stat-crit-dmg').innerText=f(getActualCD())+"%";
        document.getElementById('stat-deadly-rate').innerText=getActualDR().toFixed(1)+"%";
        document.getElementById('stat-deadly-dmg').innerText=f(getActualDD())+"x";
        document.getElementById('stat-rebirths-main').innerText=state.rebirthCount;
        document.getElementById('stat-dsp-main').innerText=f(state.dsp);
        document.getElementById('current-rebirth-points').innerText=f(state.pendingDsp||0);
        let ok=Math.ceil(state.maxStage/10)>10; document.getElementById('btn-rebirth').disabled=!ok;
        document.getElementById('r-lock-stage').innerText=Math.ceil(state.maxStage/10); document.getElementById('rebirth-lock-text').style.display=ok?'none':'block';

        let cKeys = [...GameConfig.Upgrades, ...GameConfig.Summons];
        cKeys.forEach(cfg => {
            let lv=state['l_'+cfg.id], c1=getUpgCostRange(cfg.id,1), c10=getUpgCostRange(cfg.id,10);
            let isS = GameConfig.Summons.some(s=>s.id===cfg.id);
            
            let btn1 = document.getElementById(`btn-${cfg.id}-1`);
            let btn10 = document.getElementById(`btn-${cfg.id}-10`);
            
            if(btn1) btn1.disabled=(state.gold<c1);
            if(btn10 && isS && lv===0) { btn10.style.display='none'; document.getElementById(`cost-${cfg.id}-1`).innerText = f(c1); }
            else if(btn10) {
                btn10.style.display='flex';
                document.getElementById(`cost-${cfg.id}-1`).innerText = f(c1);
                document.getElementById(`cost-${cfg.id}-10`).innerText = f(c10);
                btn10.disabled=(state.gold<c10);
            }
            
            if(lv===0 && isS) { 
                document.getElementById(`lvl-${cfg.id}`).innerText="æœªä¹ "; 
                document.getElementById(`desc-${cfg.id}`).innerHTML=`<span style="color:#789e83;">è§£é”åå¢åŠ æ¯åˆ†é’Ÿè‡ªåŠ¨æ”»å‡» <strong style="color:#d35400">${cfg.baseFreq}</strong> æ¬¡</span>`; 
            } 
            else {
                document.getElementById(`lvl-${cfg.id}`).innerText=`Lv.${lv}`;
                if(isS) { document.getElementById(`desc-${cfg.id}`).innerHTML=`<span style="color:#5a8a65;">ä¸‹ä¸€çº§: <strong style="color:#27ae60">+${cfg.freqStep}</strong> æ¬¡/åˆ†</span><br><span style="color:#d48a42;">æ€»åŠ æˆ: <strong style="color:#d35400">${cfg.baseFreq+(lv-1)*cfg.freqStep}</strong> æ¬¡/åˆ†</span>`; } 
                else {
                    let totalStr = ""; if(cfg.id==='dmg') totalStr=f(state.dmg-GameConfig.Settings.baseAttack)+cfg.unit; else if(cfg.id==='cR') totalStr=(state.l_cR*cfg.uStep).toFixed(1)+cfg.unit; else if(cfg.id==='cD') totalStr=(state.l_cD*cfg.uStep)+cfg.unit; else if(cfg.id==='dd') totalStr=(state.l_dd*cfg.uStep)+cfg.unit;
                    let nextStr = ""; if(cfg.id==='dmg') nextStr=f(Math.pow(2,Math.floor(state.l_dmg/20)))+cfg.unit; else nextStr=cfg.uStep+cfg.unit;
                    document.getElementById(`desc-${cfg.id}`).innerHTML=`<span style="color:#5a8a65;">ä¸‹ä¸€çº§: <strong style="color:#27ae60">+${nextStr}</strong></span><br><span style="color:#d48a42;">æ€»åŠ æˆ: <strong style="color:#d35400">+${totalStr}</strong></span>`;
                }
            }
        });

        document.getElementById('btn-challenge').style.display=(state.cStage<state.maxStage)?'block':'none';
        GameConfig.Summons.forEach(s => { let d = document.getElementById(`ava-${s.id}`); if(d) d.classList.toggle('active', state['l_'+s.id]>0); });
    }

    function fastSyncMonsterUI() {
        let st=state.cStage, rnd=Math.ceil(st/10), midx=(st-1)%10+1, sI=document.getElementById('stage-info-text');
        if(isBoss) { sI.innerHTML=`ç¬¬ ${rnd} è½®é“åŠ« - ğŸŒŸ <span style="color:#d66453">${mythicNames[(st*13)%mythicNames.length]}</span>`; document.getElementById('boss-timer-wrap').style.display='inline-block'; if(bossExpireTime===0)bossExpireTime=Date.now()+90000; } 
        else { sI.innerHTML=`ç¬¬ ${rnd} è½® - ${midx}é‡çµå° [${mythicNames[(st*13)%mythicNames.length]}]`; document.getElementById('boss-timer-wrap').style.display='none'; }
        
        let mArr = GameConfig.Images.monsters; 
        let safePool = mArr.filter(i => i.trim() !== ""); 
        let cImg = safePool.length > 0 ? safePool[st % safePool.length] : "";
        
        elM.classList.toggle('boss',isBoss);
        
        if(cImg) {
            elM.style.background = `url('${cImg}') center/contain no-repeat transparent`;
            elM.style.backgroundImage = `url('${cImg}')`; 
            elM.style.border = 'none'; elM.style.boxShadow = 'none'; elM.innerText = '';
        } else {
            elM.style.background=`linear-gradient(135deg,hsl(${(isBoss?rnd*55:st*30)%360},${isBoss?65:30}%,75%),hsl(${(isBoss?rnd*55:st*30)%360},${isBoss?65:30}%,55%))`; 
            elM.style.backgroundImage = ''; 
            elM.style.border= isBoss ? '3px solid #d66453' : '2px solid #fff'; 
            elM.style.boxShadow= isBoss ? '' : 'inset 0 0 10px rgba(255,255,255,0.8), 0 4px 8px rgba(0,0,0,0.05)';
            elM.innerText=emojis[(st*7)%emojis.length]; 
        }
        document.getElementById('hp-current').innerText=f(state.hpCurrent); document.getElementById('hp-max').innerText=f(state.hpMax); document.getElementById('hp-bar').style.width=Math.max(0,(state.hpCurrent/state.hpMax)*100)+'%';
    }

    function spawnMonster(st,rH=false){ let midx=(st-1)%10+1; isBoss=(midx===10); state.hpMax=getStageHp(st); if(rH||state.hpCurrent<=0)state.hpCurrent=state.hpMax; if(!isBoss)bossExpireTime=0; needUIUpdate=true; }
    function challengeBoss(){state.cStage=state.maxStage; spawnMonster(state.cStage,true); updateUI(); fastSyncMonsterUI();}
</script>
</body>
</html>