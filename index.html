<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ´ªè’ä»™å½• - å¯»é“å¤§åƒç‰ˆ</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", "Microsoft YaHei", sans-serif; background-color: #0b0f14; color: #dfe6e9; text-align: center; margin: 0; padding: 0; user-select: none; display: flex; justify-content: center; height: 100vh; overflow: hidden; -webkit-tap-highlight-color: transparent;}
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #dcb974, #8a6d3b); border-radius: 4px; }
        
        #rebirth-flash { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: radial-gradient(circle, #fff 0%, #f1c40f 60%, rgba(255,255,255,0) 100%); z-index: 10000; opacity: 0; pointer-events: none; transition: opacity 0.8s ease-in-out; display: none; align-items: center; justify-content: center; }
        .rebirth-text { font-size: 55px; font-weight: 900; color: #fff; letter-spacing: 8px; text-shadow: 0 0 20px #8e44ad, 0 0 40px #d35400, 0 0 60px #c0392b; opacity: 0; transform: scale(0.2); transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        .viewport { display: flex; flex-direction: column; width: 100%; max-width: 600px; height: 100vh; background: #121820; box-shadow: 0 0 30px rgba(0,0,0,0.9); transition: opacity 1s ease-in-out; position: relative;}
        
        .top-panel { padding: 8px 12px 10px 12px; background: linear-gradient(180deg, #182433 0%, #11171f 100%); border-bottom: 2px solid #4a3a24; flex-shrink: 0; position:relative; z-index: 10; box-shadow: 0 4px 10px rgba(0,0,0,0.6);}
        .scroll-panel { flex: 1; overflow-y: auto; padding: 15px; background-color: #141a22; background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 15px 15px; position: relative; }
        
        .tab-bar { display: flex; flex-shrink: 0; background: #0c1117; border-top: 1px solid #233140; height: 60px; box-shadow: 0 -4px 10px rgba(0,0,0,0.5); padding-bottom: env(safe-area-inset-bottom);}
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #63768d; font-size: 11px; font-weight: bold; cursor: pointer; transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); border-bottom: 3px solid transparent;}
        .tab-icon { font-size: 18px; margin-bottom: 2px; filter: grayscale(1); transition: 0.3s; }
        .tab-item.active { color: #dcb974; background: radial-gradient(ellipse at bottom, rgba(220,185,116,0.15) 0%, transparent 60%); position: relative; }
        .tab-item.active .tab-icon { filter: grayscale(0) drop-shadow(0 0 5px rgba(220,185,116,0.6)); transform: translateY(-2px);}
        .tab-item.active::after { content: ''; position: absolute; bottom: 0; left: 20%; width: 60%; height: 3px; background: #dcb974; border-radius: 3px 3px 0 0; box-shadow: 0 0 8px #dcb974;}

        .header-section { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .header-name { font-size: 15px; font-weight: bold; color: #00cec9; text-shadow: 0 0 8px rgba(0,206,201,0.5); border-left: 3px solid #00cec9; padding-left: 6px;}
        .save-load-btn { background: linear-gradient(180deg, #3a4b5c 0%, #202b36 100%); color: #fff; border: 1px solid #556c82; padding: 3px 8px; border-radius: 12px; cursor: pointer; font-size: 10px; margin-left: 3px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); font-weight:bold;}
        
        .gold-display { display: inline-block; background: rgba(0,0,0,0.5); border: 1px solid #dcb974; border-radius: 20px; padding: 3px 15px; font-size: 18px; color: #ffd700; box-shadow: inset 0 0 10px rgba(220, 185, 116, 0.2), 0 2px 5px rgba(0,0,0,0.5); margin-bottom: 6px; font-weight: 900; letter-spacing: 1px;}
        .gold-icon { display: inline-block; background: linear-gradient(135deg, #f1c40f, #d35400); color: #fff; font-size: 11px; font-weight: 900; width: 18px; height: 18px; line-height: 18px; text-align: center; border-radius: 50%; margin-right: 4px; vertical-align: middle; box-shadow: 0 1px 3px rgba(0,0,0,0.5); }

        /* æè‡´å‹ç¼©å±æ€§é¢æ¿ï¼šä¸€è¡Œ4ä¸ªï¼Œå…±2è¡Œ */
        .stats-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; background: linear-gradient(135deg, rgba(30,40,50,0.8), rgba(15,20,25,0.95)); border: 1px solid rgba(220, 185, 116, 0.25); border-radius: 8px; padding: 5px; box-shadow: inset 0 0 10px rgba(0,0,0,0.8), 0 3px 6px rgba(0,0,0,0.6); margin-bottom: 8px; }
        .stats-item { background: rgba(0,0,0,0.4); border-radius: 4px; padding: 3px 2px; text-align: center; border: 1px solid rgba(255,255,255,0.04); font-size: 9px; color: #7f8fa6; line-height: 1.2; box-shadow: inset 0 1px 2px rgba(0,0,0,0.5); overflow: hidden; white-space: nowrap;}
        .stats-item .sv { display: block; font-size: 12px; font-weight: bold; margin-top: 1px; color: #fff; text-shadow: 0 1px 2px #000; }

        /* æˆ˜æ–—åŒºåŸŸåŠ é«˜ */
        .monster-area { position: relative; min-height: 210px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; border: 1px solid rgba(220, 185, 116, 0.3); box-shadow: inset 0 0 30px rgba(0,0,0,0.8), 0 5px 15px rgba(0,0,0,0.5); background: radial-gradient(circle at center 70%, #293b4c 0%, #151d26 60%, #0a0e14 100%); overflow: hidden; padding-bottom: 10px; flex: 1;}
        
        .stage-info { display: inline-block; background: rgba(46, 213, 115, 0.15); border: 1px solid rgba(46, 213, 115, 0.4); padding: 3px 12px; border-radius: 15px; color: #2ed573; font-size: 12px; font-weight: bold; position: absolute; top: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.5);}
        .boss-timer { font-size: 11px; color: #ff4757; margin-left: 5px; animation: pulseText 1s infinite alternate; }
        @keyframes pulseText { from { opacity: 1; } to { opacity: 0.5; } }
        
        .monster-wrapper { position: relative; width: 90px; height: 90px; display: flex; align-items: center; justify-content: center; z-index: 10; cursor: pointer; margin-top: 25px;}
        .monster-wrapper::after { content: ''; position: absolute; bottom: -14px; left: 50%; transform: translateX(-50%); width: 75px; height: 18px; background: radial-gradient(ellipse, rgba(0,0,0,0.7) 0%, transparent 70%); z-index: 1; pointer-events: none;}
        
        .monster { position: absolute; left: 0; top: 0; width: 100%; height: 100%; box-sizing: border-box; background-color: #576574; border-radius: 20%; display: flex; align-items: center; justify-content: center; font-size: 44px; border: 2px solid rgba(255,255,255,0.15); box-shadow: inset 0 0 15px rgba(0,0,0,0.6), 0 5px 10px rgba(0,0,0,0.5); transition: transform 0.05s, box-shadow 0.05s, border-radius 0.2s; z-index: 10; pointer-events: none;}
        .monster-wrapper:active .monster { transform: translateY(6px) !important; box-shadow: 0 0 0 rgba(0,0,0,0) !important; }
        
        .monster.hit { animation: hitReaction 0.15s ease-out; }
        @keyframes hitReaction { 0% { transform: scale(1); filter: brightness(1); } 20% { transform: scale(0.85); filter: brightness(2.5) drop-shadow(0 0 20px red); background-color: #ff4757 !important; } 100% { transform: scale(1); filter: brightness(1); } }
        
        .monster.boss { border-radius: 25%; outline: none; border: 2px solid #ff3838; animation: rainbowShadow 2s linear infinite, bossFloat 3s infinite ease-in-out; }
        .monster-wrapper:active .monster.boss { transform: translateY(8px) !important; box-shadow: 0 0 0 transparent !important; animation: rainbowShadow 2s linear infinite !important; }
        @keyframes bossFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        @keyframes rainbowShadow { 0% { box-shadow: 0 0 15px #ff0000; } 33% { box-shadow: 0 0 15px #00ff00; } 66% { box-shadow: 0 0 15px #0000ff; } 100% { box-shadow: 0 0 15px #ff0000; } }

        .monster-ghost { position: absolute; left: 0; top: 0; width: 100%; height: 100%; box-sizing: border-box; border-radius: 20%; display: flex; align-items: center; justify-content: center; font-size: 44px; z-index: 15; pointer-events: none; animation: ghost-shatter 0.35s forwards cubic-bezier(0.1, 0.9, 0.2, 1); border: 2px solid transparent;}
        .monster-ghost.boss { border-radius: 25%; border-color:#ff3838; }
        @keyframes ghost-shatter { 0% { transform: scale(1); opacity: 1; filter: sepia(0.5) brightness(1.5) drop-shadow(0 0 10px #ff0); } 100% { transform: scale(1.8) rotate(15deg); opacity: 0; filter: blur(5px) brightness(2); } }
        .monster.spawn { animation: drop-spawn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards !important; }
        @keyframes drop-spawn { 0% { transform: translateY(-200px) scale(0.6) rotate(-10deg); opacity: 0; } 50% { transform: translateY(10px) scale(1.05) rotate(5deg); opacity: 1; } 75% { transform: translateY(-5px) scale(0.98) rotate(-2deg); } 100% { transform: translateY(0) scale(1) rotate(0deg); opacity: 1; } }
        .dust-l, .dust-r { position: absolute; bottom: 0; width: 30px; height: 12px; background: rgba(220,220,220,0.6); border-radius: 50%; z-index: 5; pointer-events: none; filter: blur(2px); }
        .dust-l { left: 0; animation: dust-anim-l 0.4s forwards ease-out; }
        .dust-r { right: 0; animation: dust-anim-r 0.4s forwards ease-out; }
        @keyframes dust-anim-l { 0% { transform: translate(10px, 5px) scale(0.5); opacity:1; } 100% { transform: translate(-45px, -15px) scale(2.5); opacity:0; } }
        @keyframes dust-anim-r { 0% { transform: translate(-10px, 5px) scale(0.5); opacity:1; } 100% { transform: translate(45px, -15px) scale(2.5); opacity:0; } }

        .avatar { position: absolute; display: none; z-index: 5; pointer-events: none; filter: drop-shadow(0 0 5px rgba(255,255,255,0.6)); }
        .avatar.active { display: block; animation: avatar-jitter 0.1s infinite linear; }
        .pos-a0 { left: -32px; top: 18px; font-size: 22px; animation-delay: 0.01s;}
        .pos-a1 { left: -10px; top: -22px; font-size: 24px; animation-delay: 0.05s;}
        .pos-a2 { right: -10px; top: -22px; font-size: 24px; animation-delay: 0.08s;}
        .pos-a3 { right: -32px; top: 18px; font-size: 24px; animation-delay: 0.02s;}
        .pos-a4 { left: calc(50% - 14px); top: -38px; font-size: 28px; animation-delay: 0.06s;}
        .pos-a5 { right: -28px; bottom: 5px; font-size: 28px; animation-delay: 0.03s;}
        @keyframes avatar-jitter { 0% { transform: translate(0, 0) rotate(0deg) scale(1.15); filter: brightness(1.7) drop-shadow(0 0 8px #ffeb3b); } 25% { transform: translate(2px, -1px) rotate(3deg) scale(1.15); } 50% { transform: translate(-2px, 2px) rotate(-3deg) scale(1.15); filter: brightness(1.2) drop-shadow(0 0 4px #ffeb3b); } 75% { transform: translate(-1px, -2px) rotate(3deg) scale(1.15); } 100% { transform: translate(1px, 1px) rotate(-3deg) scale(1.15); filter: brightness(1.7) drop-shadow(0 0 8px #ffeb3b); } }

        .hp-bar-container { width: 70%; height: 14px; background: #111; border-radius: 8px; margin-top: 30px; overflow: hidden; position: relative; border: 1px solid #000; box-shadow: 0 0 0 2px #5a4b31, 0 4px 6px rgba(0,0,0,0.5); z-index: 10; }
        .hp-bar { height: 100%; background: linear-gradient(180deg, #ff4757 0%, #c0392b 100%); width: 100%; transition: width 0.1s linear; box-shadow: inset 0 2px 2px rgba(255,255,255,0.3);}
        .hp-text { position: absolute; top: 0; left: 0; width: 100%; text-align: center; font-size: 10px; line-height: 14px; font-weight: bold; color: #fff; text-shadow: 1px 1px 2px #000; }
        
        .challenge-btn { position: absolute; bottom: 12px; right: 12px; background: linear-gradient(180deg, #e74c3c 0%, #8e1f14 100%); color: white; border: 2px solid #ff7979; padding: 5px 14px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: bold; display: none; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4), inset 0 1px 2px rgba(255,255,255,0.3); z-index: 11; letter-spacing: 1px;}
        .challenge-btn:active { transform: translateY(2px); box-shadow: 0 1px 4px rgba(231, 76, 60, 0.4); }
        
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .upgrades { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 450px) { .upgrades { grid-template-columns: 1fr; } }
        .toggle-high-btn { background: linear-gradient(135deg, #2b3a4a, #1a252f); color: #dcb974; width: 100%; border: 1px dashed #556c82; padding: 12px; border-radius: 8px; margin-top: 15px; cursor: pointer; font-weight: bold; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.3);}

        .upg-item { background: linear-gradient(135deg, #1e2a38 0%, #151d26 100%); border: 1px solid #2c3e50; border-left: 4px solid #3498db; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; gap: 6px; box-shadow: 0 4px 8px rgba(0,0,0,0.5); text-align: left;}
        .upg-item.disabled-in-auto { opacity: 0.5; pointer-events: none; filter: grayscale(50%); }
        .upg-item .title-row { display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 13px; color: #dcb974; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px; margin-bottom: 2px;}
        .lvl-badge { background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 10px; border: 1px solid #00cec9; color: #00cec9; font-size: 10px; margin-right: 4px;}
        .upg-item .desc-row { font-size: 11px; line-height: 1.5; min-height: 34px; background: rgba(0,0,0,0.25); border: 1px solid rgba(0,0,0,0.5); padding: 5px; border-radius: 4px; color: #dfe6e9; box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);}
        
        .upg-actions { display: flex; gap: 6px; margin-top: 2px;}
        .upg-act-btn { flex: 1; background: linear-gradient(180deg, #2980b9 0%, #17425e 100%); border: 1px solid #3498db; color: #fff; border-radius: 6px; padding: 8px 0; font-size: 11px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2); cursor: pointer;}
        .upg-act-btn:active:not(:disabled) { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0,0,0,0.4); }
        .upg-act-btn.btn-10x { background: linear-gradient(180deg, #d35400 0%, #8e3900 100%) !important; border: 1px solid #e67e22; }
        .upg-act-btn:disabled { background: #2c3e50 !important; border: 1px solid #1a252f !important; color: #5a6b7c !important; box-shadow: none !important; cursor: not-allowed; }
        
        .item-core { border-left-color: #0984e3; } .item-deadly { border-left-color: #9b59b6; }
        .item-auto { border-left-color: #95a5a6; } .item-nezha { border-left-color: #e74c3c; } 
        .item-yangjian { border-left-color: #00cec9; } .item-wukong { border-left-color: #e67e22; }
        .item-guanyin { border-left-color: #fd79a8; } .item-rulai { border-left-color: #f1c40f; }

        .treasure-header { font-size: 14px; color: #dcb974; font-weight: bold; margin-bottom: 15px; padding: 10px; background: linear-gradient(90deg, #1e2a38 0%, #151d26 100%); border-radius: 8px; text-align: left; border: 1px solid #34495e; border-left: 4px solid #f1c40f; box-shadow: 0 4px 6px rgba(0,0,0,0.3);}
        .treasure-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .treasure-item { background: linear-gradient(135deg, #1e2a38 0%, #151d26 100%); border: 1px solid #2c3e50; border-radius: 8px; padding: 10px; font-size: 11px; box-shadow: 0 4px 8px rgba(0,0,0,0.4); display:flex; flex-direction:column; justify-content:center; text-align:left;}
        .treasure-item.locked { filter: grayscale(60%) brightness(0.6); }
        .treasure-item.owned { border-left: 3px solid #00cec9; }
        
        .t-act-btn { background: linear-gradient(180deg, #2980b9 0%, #17425e 100%); border: 1px solid #3498db; color: #fff; padding: 8px 0; font-size: 11px; font-weight:bold; border-radius: 6px; cursor: pointer; flex: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.2);}
        .t-act-btn.t-10x { background: linear-gradient(180deg, #d35400 0%, #8e3900 100%); border: 1px solid #e67e22; }
        .t-act-btn:active:not(:disabled) { transform: translateY(1px); box-shadow: none; }
        .t-act-btn:disabled { background: #2c3e50; border-color: #1a252f; color: #5a6b7c; cursor: not-allowed; box-shadow:none;}
        .t-actions { display: flex; gap: 6px; margin-top: 8px; }

        .quest-item { background: linear-gradient(90deg, #1a252f 0%, #141c24 100%); padding: 12px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border: 1px solid rgba(220, 185, 116, 0.2); border-left: 4px solid #dcb974; box-shadow: 0 4px 6px rgba(0,0,0,0.3); text-align: left;}
        .btn-claim { background: #2c3e50; color: #5a6b7c; border: 1px solid #1a252f; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: not-allowed; min-width:70px; text-align:center;}
        .btn-claim.active { background: linear-gradient(180deg, #f1c40f 0%, #d35400 100%); color: #4a2100; border: 1px solid #f39c12; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.5), inset 0 1px 1px rgba(255,255,255,0.4); text-shadow: 1px 1px 0 rgba(255,255,255,0.3);}
        .btn-claim.done { background: linear-gradient(180deg, #27ae60 0%, #1e8449 100%); border: 1px solid #2ecc71; color: #fff; box-shadow:none;}

        .rebirth-area { background: radial-gradient(circle, rgba(142,68,173,0.1) 0%, rgba(0,0,0,0.4) 100%), #151d26; border: 1px solid #8e44ad; padding: 25px 20px; border-radius: 12px; margin-top: 10px; display: block; box-shadow: inset 0 0 20px rgba(142,68,173,0.3), 0 5px 15px rgba(0,0,0,0.5);}
        .rebirth-btn { background: linear-gradient(180deg, #f1c40f 0%, #d35400 100%); color: #4a2100; font-size: 22px; font-weight: 900; padding: 15px 30px; border: 2px solid #ffd700; border-radius: 30px; cursor: pointer; box-shadow: 0 6px 15px rgba(211, 84, 0, 0.5), inset 0 2px 3px rgba(255,255,255,0.4); text-shadow: 1px 1px 0px rgba(255,255,255,0.5); letter-spacing: 2px; transition: transform 0.1s; width: 100%;}
        .rebirth-btn:active:not(:disabled) { transform: translateY(4px); box-shadow: 0 2px 5px rgba(211, 84, 0, 0.5); }
        .rebirth-btn:disabled { background: #2c3e50 !important; border: 2px solid #1a252f !important; color: #5a6b7c !important; cursor: not-allowed; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5) !important; text-shadow:none;}

        .lb-title { font-size: 16px; color: #dcb974; font-weight: bold; margin-bottom: 15px; padding: 10px; background: linear-gradient(90deg, #1e2a38 0%, #151d26 100%); border-radius: 8px; text-align: left; border: 1px solid #34495e; border-left: 4px solid #f1c40f; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .lb-list { display: flex; flex-direction: column; gap: 8px; padding-bottom: 20px;}
        .lb-item { display: flex; align-items: center; justify-content: space-between; background: linear-gradient(90deg, #1e2a38 0%, #151d26 100%); padding: 12px 15px; border-radius: 8px; font-size: 13px; font-weight:bold; color: #dfe6e9; border: 1px solid #2c3e50; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.2);}
        .lb-rank { width: 40px; text-align: left; font-size: 16px; }
        .lb-name { flex: 1; text-align: left; }
        .lb-round { color: #f1c40f; text-shadow: 0 0 3px rgba(241,196,15,0.4);}
        
        .lb-item.rank-1 { background: linear-gradient(90deg, #d35400 0%, #f39c12 50%, #d35400 100%); border: 1px solid #f1c40f; color: #4a2100; transform: scale(1.02); box-shadow: 0 4px 15px rgba(241, 196, 15, 0.5); z-index: 3;}
        .lb-item.rank-2 { background: linear-gradient(90deg, #7f8c8d 0%, #bdc3c7 50%, #7f8c8d 100%); border: 1px solid #ecf0f1; color: #2c3e50; box-shadow: 0 4px 10px rgba(189, 195, 199, 0.4); z-index: 2;}
        .lb-item.rank-3 { background: linear-gradient(90deg, #8e44ad 0%, #9b59b6 50%, #8e44ad 100%); border: 1px solid #e056fd; color: #fff; box-shadow: 0 4px 10px rgba(142, 68, 173, 0.4); z-index: 1;}
        .lb-item.rank-1 .lb-rank, .lb-item.rank-1 .lb-name, .lb-item.rank-1 .lb-round, 
        .lb-item.rank-2 .lb-rank, .lb-item.rank-2 .lb-name, .lb-item.rank-2 .lb-round { color: inherit; text-shadow: none; }
        .lb-item.rank-3 .lb-rank, .lb-item.rank-3 .lb-name, .lb-item.rank-3 .lb-round { color: #fff; text-shadow: 0 1px 2px #000; }
        
        .lb-item.is-player { border: 2px solid #00cec9; background: linear-gradient(180deg, #132b31 0%, #0a1619 100%) !important; box-shadow: 0 0 15px rgba(0,206,201,0.5); transform: scale(1.02); z-index: 4;}
        .lb-item.is-player .lb-rank, .lb-item.is-player .lb-name, .lb-item.is-player .lb-round { color: #00cec9 !important; font-size: 16px; font-weight: 900; text-shadow: 0 0 8px rgba(0,206,201,0.8); animation: pulsePlayerText 1.5s infinite alternate;}
        @keyframes pulsePlayerText { from { opacity: 0.8;} to { opacity: 1; text-shadow: 0 0 15px #00cec9, 0 0 5px #fff;} }

        .auto-compact-bar { background: linear-gradient(135deg, #1e2a38 0%, #151d26 100%); border: 1px solid rgba(52, 152, 219, 0.5); border-radius: 10px; padding: 15px; margin-top: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);}
        .auto-input { background: rgba(0,0,0,0.5); border: 1px solid #3498db; color: #f1c40f; font-weight: bold; text-align: center; width: 60px; padding: 8px; border-radius: 6px; font-size:15px; margin: 0 5px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.8);}
        .auto-btn { background: linear-gradient(180deg, #2980b9 0%, #17425e 100%); color: #fff; border: 1px solid #3498db; padding: 8px 18px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size:14px; box-shadow: 0 2px 5px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.2);}
        .auto-btn.active { background: linear-gradient(180deg, #e74c3c 0%, #922b21 100%); border-color: #ff4757; }

        .floating-damage { position: absolute; color: #fff; font-weight: 900; font-size: 26px; pointer-events: none; animation: floatUp 0.8s forwards ease-out; font-family: 'Impact', 'Arial Black', sans-serif; -webkit-text-stroke: 1px #000; text-shadow: 2px 2px 0 #000; z-index: 20; letter-spacing: 1px; font-style: italic;}
        .crit-damage { color: #ff9f43; font-size: 34px; -webkit-text-stroke: 1.5px #c0392b; text-shadow: 0 0 10px #ff0000; z-index: 21; }
        .deadly-damage { color: #e056fd; font-size: 44px; -webkit-text-stroke: 2px #8e44ad; text-shadow: 0 0 15px #8e44ad, 3px 3px 0 #000; z-index: 22;}
        .auto-dmg-mark { font-size: 16px; opacity:0.8; margin-right:4px; vertical-align:middle; -webkit-text-stroke: 0;}
        @keyframes floatUp { 0% { opacity: 0; transform: translateY(10px) scale(0.5); } 15% { opacity: 1; transform: translateY(-10px) scale(1.1); } 100% { opacity: 0; transform: translateY(-70px) scale(0.9); } }

        #start-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.95); display: flex; align-items: center; justify-content: center; flex-direction: column; z-index: 10001; }
        #start-overlay .modal { background: linear-gradient(180deg, #2b3a4a 0%, #1a252f 100%); border: 2px solid #dcb974; box-shadow: 0 0 40px rgba(0,0,0,0.9), inset 0 0 30px rgba(220,185,116,0.15); border-radius: 16px; padding: 35px; max-width: 400px; width: 80%;}
        .ui-input { box-sizing:border-box; width: 100%; padding: 10px; border-radius: 6px; font-size: 16px; margin-bottom: 20px; text-align: center; font-weight: bold; background: rgba(0,0,0,0.4); border: 1px solid #dcb974; color: #dcb974; box-shadow: inset 0 2px 5px rgba(0,0,0,0.8);}
        .ui-input::placeholder { color: rgba(220,185,116,0.5); }
    </style>
</head>
<body>

<div id="rebirth-flash">
    <div class="rebirth-text" id="rebirth-text">é€†å¤©æ”¹å‘½ï¼</div>
</div>

<div id="start-overlay">
    <div class="modal">
        <h2 style="color:#dcb974; margin-top:0; text-shadow: 0 2px 4px #000;">ğŸ“– æ´ªè’ä»™å½•</h2>
        <p style="font-size:14px; color:#a4b0be; margin-bottom:20px;">ä¸‡æ³•çš†è™šï¼Œå”¯é“é•¿å­˜ã€‚</p>
        <input type="text" id="player-name-input" class="ui-input" placeholder="è¾“å…¥é“å·" />
        <button class="upg-item item-core" style="width:100%; text-align:center; cursor:pointer; align-items:center;" onclick="startGame()">
            <span style="font-size:15px; font-weight:bold; color:#dcb974;">âš”ï¸ å‡ç»“å‡¡èº¯ (å¼€å§‹æ¸¸æˆ)</span>
        </button>
        <div style="font-size:12px; color:#556c82; margin:12px 0;">â€”â€”â€” æˆ– â€”â€”â€”</div>
        <button class="upg-item item-auto" style="width:100%; text-align:center; cursor:pointer; align-items:center;" onclick="loadAutoSave()">
            <span style="font-size:14px; color:#dfe6e9;">â±ï¸ è¯»å–è‡ªåŠ¨å­˜æ¡£</span>
        </button>
        <div style="font-size:12px; color:#556c82; margin:12px 0;">â€”â€”â€” æˆ– â€”â€”â€”</div>
        <button class="upg-item item-auto" style="width:100%; text-align:center; cursor:pointer; align-items:center;" onclick="document.getElementById('file-import-init').click()">
            <span style="font-size:14px; color:#dfe6e9;">ğŸ“‚ å¯¼å…¥æœ¬åœ°å­˜æ¡£</span>
        </button>
        <input type="file" id="file-import-init" accept=".json" onchange="importSaveData(event)" style="display:none;" />
    </div>
</div>

<div class="viewport" id="viewport-main">
    <div class="top-panel">
        <div class="header-section">
            <div class="header-name" id="display-name">ã€æœªå‘½åã€‘</div>
            <div style="display:flex; align-items:center;">
                <span id="auto-save-time" style="font-size:9px; color:#7f8fa6; margin-right:4px; font-weight:bold;">æœªå­˜æ¡£</span>
                <button class="save-load-btn" onclick="exportSaveData()">ğŸ’¾å¯¼å‡º</button>
                <button class="save-load-btn" onclick="document.getElementById('file-import-ingame').click()">ğŸ“‚å¯¼å…¥</button>
                <input type="file" id="file-import-ingame" accept=".json" onchange="importSaveData(event)" style="display:none;" />
            </div>
        </div>
        <div class="gold-display"><span class="gold-icon">é‡‘</span> <span id="gold">0</span></div>
        
        <!-- æè‡´å‹ç¼©ï¼šä¸€è¡Œ4ä¸ªï¼Œå…±2è¡Œ -->
        <div class="stats-board">
            <div class="stats-item">æ”»å‡»<span class="sv" id="stat-dmg" style="color:#ff9f43">1</span></div>
            <div class="stats-item">è‡ªåŠ¨/åˆ†<span class="sv" id="stat-auto" style="color:#2ed573">0</span></div>
            <div class="stats-item">æš´ç‡<span class="sv" id="stat-crit-rate" style="color:#f1c40f">0%</span></div>
            <div class="stats-item">æš´ä¼¤<span class="sv" id="stat-crit-dmg" style="color:#f1c40f">150%</span></div>
            <div class="stats-item">è‡´å‘½ç‡<span class="sv" id="stat-deadly-rate" style="color:#e056fd">1%</span></div>
            <div class="stats-item">è‡´å‘½å€<span class="sv" id="stat-deadly-dmg" style="color:#e056fd">10x</span></div>
            <div class="stats-item">é‡ç”Ÿ<span class="sv" id="stat-rebirths-main" style="color:#00cec9">0</span></div>
            <div class="stats-item">ç•Œç‚¹<span class="sv" id="stat-dsp-main" style="color:#dcb974">0</span></div>
        </div>
        
        <!-- æˆ˜æ–—åŒºåŸŸ -->
        <div class="monster-area" id="monster-area">
            <div class="stage-info">
                <span id="stage-info-text">ç¬¬ 1 è½® - æå° 1</span>
                <span class="boss-timer" id="boss-timer-wrap">(å€’è®¡: <span id="timer-text">90</span>s)</span>
            </div>
            <div class="monster-wrapper" id="monster-wrapper" onclick="attackHnd(event)">
                <div id="ava-a0" class="avatar pos-a0">ğŸ¤–</div>
                <div id="ava-a1" class="avatar pos-a1">ğŸ”¥</div>
                <div id="ava-a2" class="avatar pos-a2">ğŸ‘ï¸</div>
                <div id="ava-a3" class="avatar pos-a3">ğŸ’</div>
                <div id="ava-a4" class="avatar pos-a4">ğŸª·</div>
                <div id="ava-a5" class="avatar pos-a5">â˜¸ï¸</div>
                <div class="monster" id="monster">ğŸ‘¾</div>
            </div>
            <div class="hp-bar-container">
                <div class="hp-bar" id="hp-bar"></div>
                <div class="hp-text"><span id="hp-current">10</span> / <span id="hp-max">10</span></div>
            </div>
            <button class="challenge-btn" id="btn-challenge" onclick="challengeBoss()">âš”ï¸ æ–© å°Š</button>
        </div>
    </div>

    <div class="scroll-panel">
        <div id="tab-upgrades" class="tab-content active">
            <div class="upgrades" id="upgrades-dom">
                <div class="upg-item item-core" id="upg-ui-dmg"><div class="title-row"><span><span class="lvl-badge" id="lvl-dmg">Lv.0</span> ğŸ—¡ï¸ åŸºç¡€æ®µä½</span></div><div class="desc-row" id="desc-dmg"></div><div class="upg-actions"><button class="upg-act-btn" id="btn-dmg-1" onclick="buyStateUpg('dmg',1)">1çº§(<span class="gold-icon">é‡‘</span><span id="cost-dmg-1"></span>)</button><button class="upg-act-btn btn-10x" id="btn-dmg-10" onclick="buyStateUpg('dmg',10)">10çº§(<span class="gold-icon">é‡‘</span><span id="cost-dmg-10"></span>)</button></div></div>
                <div class="upg-item item-core" id="upg-ui-cR"><div class="title-row"><span><span class="lvl-badge" id="lvl-cR">Lv.0</span> ğŸ¯ æå‡æš´ç‡</span></div><div class="desc-row" id="desc-cR"></div><div class="upg-actions"><button class="upg-act-btn" id="btn-cR-1" onclick="buyStateUpg('cR',1)">1çº§(<span class="gold-icon">é‡‘</span><span id="cost-cR-1"></span>)</button><button class="upg-act-btn btn-10x" id="btn-cR-10" onclick="buyStateUpg('cR',10)">10çº§(<span class="gold-icon">é‡‘</span><span id="cost-cR-10"></span>)</button></div></div>
                <div class="upg-item item-core" id="upg-ui-cD"><div class="title-row"><span><span class="lvl-badge" id="lvl-cD">Lv.0</span> ğŸ’¥ æé«˜æš´ä¼¤</span></div><div class="desc-row" id="desc-cD"></div><div class="upg-actions"><button class="upg-act-btn" id="btn-cD-1" onclick="buyStateUpg('cD',1)">1çº§(<span class="gold-icon">é‡‘</span><span id="cost-cD-1"></span>)</button><button class="upg-act-btn btn-10x" id="btn-cD-10" onclick="buyStateUpg('cD',10)">10çº§(<span class="gold-icon">é‡‘</span><span id="cost-cD-10"></span>)</button></div></div>
                <div class="upg-item item-deadly" id="upg-ui-dd"><div class="title-row"><span><span class="lvl-badge" id="lvl-dd">Lv.0</span> â˜ ï¸ è‡´å‘½å€ç‡</span></div><div class="desc-row" id="desc-dd"></div><div class="upg-actions"><button class="upg-act-btn" id="btn-dd-1" onclick="buyStateUpg('dd',1)">1çº§(<span class="gold-icon">é‡‘</span><span id="cost-dd-1"></span>)</button><button class="upg-act-btn btn-10x" id="btn-dd-10" onclick="buyStateUpg('dd',10)">10çº§(<span class="gold-icon">é‡‘</span><span id="cost-dd-10"></span>)</button></div></div>
                <div class="upg-item item-auto" id="upg-ui-a0"><div class="title-row"><span><span class="lvl-badge" id="lvl-a0">æœªå¼€å¯</span> ğŸ¤– åŸºç¡€æŒ‚æœº</span></div><div class="desc-row" id="desc-a0"></div><div class="upg-actions"><button class="upg-act-btn" id="btn-a0-1" onclick="buyStateUpg('a0',1)">1çº§(<span class="gold-icon">é‡‘</span><span id="cost-a0-1"></span>)</button><button class="upg-act-btn btn-10x" id="btn-a0-10" onclick="buyStateUpg('a0',10)">10çº§(<span class="gold-icon">é‡‘</span><span id="cost-a0-10"></span>)</button></div></div>
                <div class="upg-item item-nezha" id="upg-ui-a1"><div class="title-row"><span><span class="lvl-badge" id="lvl-a1">æœªå¬å”¤</span> ğŸ”¥ å”¤ å“ªå’</span></div><div class="desc-row" id="desc-a1"></div><div class="upg-actions"><button class="upg-act-btn" id="btn-a1-1" onclick="buyStateUpg('a1',1)">1çº§(<span class="gold-icon">é‡‘</span><span id="cost-a1-1"></span>)</button><button class="upg-act-btn btn-10x" id="btn-a1-10" onclick="buyStateUpg('a1',10)">10çº§(<span class="gold-icon">é‡‘</span><span id="cost-a1-10"></span>)</button></div></div>
            </div>
            <button class="toggle-high-btn" id="toggle-high-btn" onclick="toggleHighUpgrades()">ğŸ”½ å±•å¼€é«˜é˜¶æ³•ç›¸ ğŸ”½</button>
            <div class="upgrades" id="high-upgrades-dom" style="display:none; margin-top:10px;">
                <div class="upg-item item-yangjian" id="upg-ui-a2"><div class="title-row"><span><span class="lvl-badge" id="lvl-a2">æœªå¬å”¤</span> ğŸ‘ï¸ å”¤ æ¨æˆ¬</span></div><div class="desc-row" id="desc-a2"></div><div class="upg-actions"><button class="upg-act-btn" id="btn-a2-1" onclick="buyStateUpg('a2',1)">1çº§(<span class="gold-icon">é‡‘</span><span id="cost-a2-1"></span>)</button><button class="upg-act-btn btn-10x" id="btn-a2-10" onclick="buyStateUpg('a2',10)">10çº§(<span class="gold-icon">é‡‘</span><span id="cost-a2-10"></span>)</button></div></div>
                <div class="upg-item item-wukong" id="upg-ui-a3"><div class="title-row"><span><span class="lvl-badge" id="lvl-a3">æœªå¬å”¤</span> ğŸ’ å­™æ‚Ÿç©º</span></div><div class="desc-row" id="desc-a3"></div><div class="upg-actions"><button class="upg-act-btn" id="btn-a3-1" onclick="buyStateUpg('a3',1)">1çº§(<span class="gold-icon">é‡‘</span><span id="cost-a3-1"></span>)</button><button class="upg-act-btn btn-10x" id="btn-a3-10" onclick="buyStateUpg('a3',10)">10çº§(<span class="gold-icon">é‡‘</span><span id="cost-a3-10"></span>)</button></div></div>
                <div class="upg-item item-guanyin" id="upg-ui-a4"><div class="title-row"><span><span class="lvl-badge" id="lvl-a4">æœªå¬å”¤</span> ğŸª· è§‚éŸ³è©è¨</span></div><div class="desc-row" id="desc-a4"></div><div class="upg-actions"><button class="upg-act-btn" id="btn-a4-1" onclick="buyStateUpg('a4',1)">1çº§(<span class="gold-icon">é‡‘</span><span id="cost-a4-1"></span>)</button><button class="upg-act-btn btn-10x" id="btn-a4-10" onclick="buyStateUpg('a4',10)">10çº§(<span class="gold-icon">é‡‘</span><span id="cost-a4-10"></span>)</button></div></div>
                <div class="upg-item item-rulai" id="upg-ui-a5"><div class="title-row"><span><span class="lvl-badge" id="lvl-a5">æœªå¬å”¤</span> â˜¸ï¸ å¦‚æ¥ä½›ç¥–</span></div><div class="desc-row" id="desc-a5"></div><div class="upg-actions"><button class="upg-act-btn" id="btn-a5-1" onclick="buyStateUpg('a5',1)">1çº§(<span class="gold-icon">é‡‘</span><span id="cost-a5-1"></span>)</button><button class="upg-act-btn btn-10x" id="btn-a5-10" onclick="buyStateUpg('a5',10)">10çº§(<span class="gold-icon">é‡‘</span><span id="cost-a5-10"></span>)</button></div></div>
            </div>
        </div>

        <div id="tab-treasures" class="tab-content">
            <div class="treasure-header">ğŸ’ ä¸‡ç•Œé™å¦–æ³•å®</div>
            <div class="treasure-grid" id="treasure-grid"></div>
        </div>
        <div id="tab-quests" class="tab-content"><div id="quest-list"></div></div>
        <div id="tab-rebirth" class="tab-content">
            <div class="rebirth-area"><p style="color:#dcb974; font-weight:bold; font-size:16px;">é€ åŒ–é™å¦–ç‚¹æ•°: <br><span id="current-rebirth-points" style="font-size:38px; color:#fff; text-shadow:0 0 15px #f1c40f, 0 2px 4px #000;">0</span> ç‚¹</p><div id="rebirth-lock-text" style="color:#e74c3c; font-size:12px; margin-bottom:12px;">éœ€æ–©è½ç¬¬10è½®é­”å°Šæ–¹å¯é‡å¡‘ï¼ç°è‡³:ç¬¬<span id="r-lock-stage">1</span>è½®</div><button class="rebirth-btn" id="btn-rebirth" onclick="doRebirth(false)" disabled>ğŸ”„ é€† å¤© æ”¹ å‘½</button></div>
            <div class="auto-compact-bar"><div style="display:flex; align-items:center; flex-wrap:wrap; gap:5px; width:100%;"><span style="color:#dcb974; font-weight:bold; font-size:13px;">âš¡ å‡»è´¥ç¬¬</span><input type="number" id="auto-stage-input" class="auto-input" min="10" value="10" /><span style="color:#dcb974; font-weight:bold; font-size:13px;">è½®é­”å°Šåè‡ªåŠ¨é‡ç”Ÿ</span><button class="auto-btn" id="btn-toggle-auto" onclick="toggleAutoRebirth()" style="margin-left:auto;">å¯ç”¨</button></div></div>
        </div>
        <div id="tab-leaderboard" class="tab-content">
            <div class="lb-title">ğŸ‘‘ ç¥é˜¶æˆ˜åŠ›å‡Œéœ„æ¦œ (TOP 100)</div>
            <div class="lb-list" id="lb-list"></div>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" id="nav-upgrades" onclick="switchTab('upgrades')"><div class="tab-icon">ğŸ“˜</div><div>åŠŸæ³•</div></div>
        <div class="tab-item" id="nav-treasures" onclick="switchTab('treasures')"><div class="tab-icon">ğŸ’</div><div>æ³•å®</div></div>
        <div class="tab-item" id="nav-quests" onclick="switchTab('quests')"><div class="tab-icon">ğŸ“œ</div><div>æ‚¬èµ</div></div>
        <div class="tab-item" id="nav-rebirth" onclick="switchTab('rebirth')"><div class="tab-icon">ğŸ”„</div><div>è½®å›</div></div>
        <div class="tab-item" id="nav-leaderboard" onclick="switchTab('leaderboard')"><div class="tab-icon">ğŸ†</div><div>å¤©æ¦œ</div></div>
    </div>
</div>

<script>
    let currentTabId = 'upgrades';
    function f(num) {
        if (!num || num === 0) return "0";
        if (num < 0) return "-" + f(-num);
        if (num >= 1e16) return parseFloat(num).toExponential(2);
        if (num >= 1e12) return parseFloat((num / 1e12).toFixed(2)) + "å…†";
        if (num >= 1e8) return parseFloat((num / 1e8).toFixed(2)) + "äº¿";
        if (num >= 1e4) return parseFloat((num / 10000).toFixed(2)) + "ä¸‡";
        if (Number.isInteger(num)) return num.toString();
        return parseFloat(num.toFixed(2));
    }

    let state = { name:"",gold:0,maxStage:1,cStage:1,hpMax:10,hpCurrent:10,dmg:1,critR:0,critD:150,deadlyD:10,l_dmg:0,c_dmg:10,l_cR:0,c_cR:10,l_cD:0,c_cD:10,l_dd:0,c_dd:100000,l_a0:0,c_a0:1000,l_a1:0,c_a1:10000,l_a2:0,c_a2:100000,l_a3:0,c_a3:1000000,l_a4:0,c_a4:10000000,l_a5:0,c_a5:100000000,quests:Array(17).fill(0),rebirthCount:0,dsp:0,pendingDsp:0,t_huntian:0,t_jingu:0,t_sanjian:0,t_yujing:0,t_lianhua:0,t_kaitian:0,t_qiankun:0,t_yuanbao:0,t_shengsi:0,lbBots:null };

    let isAutoRebirth=false,needUIUpdate=false,isHighExpanded=false,isRebirthing=false;
    let pendingShouldPlayDeath=false,sn_emoji="",sn_color="",sn_boss=false;
    const upgradeKeys=['dmg','cR','cD','dd','a0','a1','a2','a3','a4','a5'];
    const csMap={'dmg':'c_dmg','cR':'c_cR','cD':'c_cD','dd':'c_dd','a0':'c_a0','a1':'c_a1','a2':'c_a2','a3':'c_a3','a4':'c_a4','a5':'c_a5'};

    const questDefs=[{desc:"åˆå…¥çº¢å°˜Â·ç¬¬1è½®é­”æ€ª",check:()=>state.maxStage>1,rewardBase:100,type:'gold'},{desc:"é™ä¼å°è¯•Â·å¼€å¯æŒ‚æœº",check:()=>state.l_a0>0,rewardBase:1000,type:'gold'},{desc:"ç»“äº¤å¤©ç¥Â·å“ªå’å…¥é˜µ",check:()=>state.l_a1>0,rewardBase:10000,type:'gold'},{desc:"å¤©çœ¼ç¥å…µÂ·æ¨æˆ¬åŠ æŒ",check:()=>state.l_a2>0,rewardBase:100000,type:'gold'},{desc:"æ–©æ–­å°˜ç¼˜Â·ç¬¬10è½®é­”å°Š",check:()=>state.maxStage>100,rewardBase:500000,type:'gold'},{desc:"å¤§åœ£å½’æ¥Â·é½å¤©å¤§åœ£",check:()=>state.l_a3>0,rewardBase:1000000,type:'gold'},{desc:"è½®å›ç ´è™šÂ·é¦–å°æ¶…æ§ƒ",check:()=>state.rebirthCount>=1,rewardBase:20,type:'dsp'},{desc:"è¸ç ´å‡Œéœ„Â·ç¬¬12è½®ç¥åŠ«",check:()=>state.maxStage>120,rewardBase:5000000,type:'gold'},{desc:"ä½›å…‰æ™®ç…§Â·è§‚éŸ³å¤§å£«",check:()=>state.l_a4>0,rewardBase:10000000,type:'gold'},{desc:"æ— ç•Œé™é­”Â·ç¬¬15è½®é­”å°Š",check:()=>state.maxStage>150,rewardBase:50000000,type:'gold'},{desc:"æ¢µéŸ³å¤©é™Â·å¦‚æ¥ä½›ç¥–",check:()=>state.l_a5>0,rewardBase:100000000,type:'gold'},{desc:"è¯›ä»™ç­é­”Â·ç¬¬20è½®é­”å°Š",check:()=>state.maxStage>200,rewardBase:10000,type:'dsp'},{desc:"ä»™é“é•¿æ²³Â·ç¬¬25è½®é­”å°Š",check:()=>state.maxStage>250,rewardBase:50000,type:'dsp'},{desc:"ç¥å¨ç›–ä¸–Â·ç¬¬30è½®é­”å°Š",check:()=>state.maxStage>300,rewardBase:100000,type:'dsp'},{desc:"ç»Ÿå¾¡ä¹¾å¤Â·ç¬¬40è½®é­”å°Š",check:()=>state.maxStage>400,rewardBase:200000,type:'dsp'},{desc:"ä¸‡æ³•å½’ä¸€Â·ç¬¬50è½®é­”å°Š",check:()=>state.maxStage>500,rewardBase:500000,type:'dsp'},{desc:"å¤§åƒä¸»å®°Â·ç¬¬100è½®é­”å°Š",check:()=>state.maxStage>1000,rewardBase:1000000,type:'dsp'}];
    const treasDefs={huntian:{name:"æ··å¤©ç»«",unlockCost:100,baseCost:10,unlockEff:10,unit:"%",desc:"æš´å‡»å‡ ç‡",color:"#ff9ff3"},jingu:{name:"é‡‘ç®æ£’",unlockCost:150,baseCost:15,unlockEff:2,unit:"%",desc:"è‡´å‘½å‡ ç‡",color:"#feca57"},sanjian:{name:"ä¸‰å°–ä¸¤åˆƒåˆ€",unlockCost:200,baseCost:20,unlockEff:100,unit:"%",desc:"æš´å‡»ä¼¤å®³",color:"#48dbfb"},yujing:{name:"ç‰å‡€ç“¶",unlockCost:300,baseCost:30,unlockEff:100,unit:"%",desc:"çµçŸ³æ•›èš",color:"#1dd1a1"},lianhua:{name:"è²èŠ±å®åº§",unlockCost:500,baseCost:50,unlockEff:20,unit:"å€",desc:"è‡´å‘½å€ç‡",color:"#ff6b6b"},kaitian:{name:"å¼€å¤©å·¨æ–§",unlockCost:1000,baseCost:100,unlockEff:100,unit:"%",desc:"æ ¹åŸºæˆ˜åŠ›",color:"#ff3838"},qiankun:{name:"ä¹¾å¤åœˆ",unlockCost:5000,baseCost:500,unlockEff:100,unit:"%",desc:"è‡ªåŠ¨é¢‘ç‡",color:"#fffa65"},yuanbao:{name:"ç´«é‡‘è‘«èŠ¦",unlockCost:8000,baseCost:800,unlockEff:500,unit:"%",desc:"é­”å°Šå·¨å¯Œ",color:"#eccc68"},shengsi:{name:"ç”Ÿæ­»ç°¿",unlockCost:10000,baseCost:1000,unlockEff:100,unit:"%",desc:"è½®å›æœ¬æº",color:"#a4b0be"}};

    let isBoss=false,bossExpireTime=0,lastLogicTick=Date.now(),autoAttackAccumulator=0;
    const mythicNames=['é¥•é¤®','ç©·å¥‡','æ¢¼æŒ','æ··æ²Œ','ç™½æ³½','éº’éºŸ','å‡¤å‡°','ä¹å°¾ç‹','æ¯•æ–¹','é‡æ˜é¸Ÿ','è ƒé±¼','é’é¾™','ç™½è™','æœ±é›€','ç„æ­¦','åŒ–è›‡','ä¹å©´'];
    const emojis=['ğŸ‘¾','ğŸ‘½','ğŸ¢','ğŸ‰','ğŸ²','ğŸ¦…','ğŸ¦','ğŸ','ğŸ¦‡','ğŸŒ‹','ğŸ‘º','ğŸ‘¹','ğŸ¦–','ğŸ¦‘'];
    const elMonsterArea=document.getElementById('monster-area'),elMonster=document.getElementById('monster'),elMonsterWrap=document.getElementById('monster-wrapper');
    const hpCache={1:10};

    function getStageHp(st){if(hpCache[st])return hpCache[st];for(let i=2;i<=st;i++){if(!hpCache[i])hpCache[i]=Math.ceil(hpCache[i-1]*1.1);}return hpCache[st];}
    function Ce(v){return Math.ceil(v);}
    function getTreasureEff(id){let lv=state['t_'+id]||0;if(lv===0)return 0;let d=treasDefs[id];return d.unlockEff+(lv-1)*(d.unlockEff*0.01);}
    function getTreasureUpgradeCost(id,cLv,n){let d=treasDefs[id],t=0,lv=cLv;for(let i=0;i<n;i++){if(lv===0)t+=d.unlockCost;else t+=d.baseCost*Math.pow(2,Math.floor(lv/100));lv++;}return t;}
    function getActualCR(){return parseFloat((state.critR+getTreasureEff('huntian')).toFixed(3));}
    function getActualCD(){return parseFloat((state.critD+getTreasureEff('sanjian')).toFixed(3));}
    function getActualDR(){return parseFloat((1+getTreasureEff('jingu')).toFixed(3));}
    function getActualDD(){return parseFloat((state.deadlyD+getTreasureEff('lianhua')).toFixed(3));}
    function getActualAtkMult(){return 1+getTreasureEff('kaitian')/100;}
    function getActualCoinMult(){return 1+getTreasureEff('yujing')/100;}

    function switchTab(tabId){document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));document.querySelectorAll('.tab-item').forEach(el=>el.classList.remove('active'));document.getElementById(`tab-${tabId}`).classList.add('active');document.getElementById(`nav-${tabId}`).classList.add('active');currentTabId=tabId;if(tabId==='leaderboard')renderLeaderboard();}
    function toggleHighUpgrades(){isHighExpanded=!isHighExpanded;let d=document.getElementById('high-upgrades-dom'),b=document.getElementById('toggle-high-btn');if(isHighExpanded){d.style.display='grid';b.innerText='ğŸ”¼ æ”¶èµ·é«˜é˜¶æ³•ç›¸ ğŸ”¼';}else{d.style.display='none';b.innerText='ğŸ”½ å±•å¼€é«˜é˜¶æ³•ç›¸ ğŸ”½';}}
    function generateBots(){if(state.lbBots&&state.lbBots.length>0)return;state.lbBots=[];let p1=["ç ´å¤©","æ³£è¡€","å‚²ä¸–","å¹½å†¥","ä¹è½¬","å¤ªè™š","æ··æ²Œ","ç„å†°","çƒˆç„°","ç‹‚é›·","ä¿®ç½—","åŒ–åŠ«","æ— æ","é’äº‘","æ˜Ÿè¾°","å¤§è’"];let p2=["å‰‘å°Š","é­”å°Š","é“ç¥–","ç¥ä¸»","å¤©å›","æ•£äºº","çœŸå›","ç‹‚å®¢","ä½¿è€…","å¤§å¸","å¤©ç‹","ä»™å­","å¦–åœ£","è¡Œè€…","å°Šè€…","çµç«¥"];for(let i=0;i<99;i++){state.lbBots.push({name:p1[Math.floor(Math.random()*p1.length)]+p2[Math.floor(Math.random()*p2.length)],round:Math.floor(Math.random()*(149-15+1))+15});}if(!state.lbBots.find(b=>b.round===150)){state.lbBots[0].round=150;state.lbBots[0].name="å¤©é“æ¸Šæº";}}
    function renderLeaderboard(){let pr=Math.ceil(state.maxStage/10);let all=[...state.lbBots,{name:state.name||"æ— å",round:pr,isPlayer:true}];all.sort((a,b)=>b.round-a.round);let h='';for(let i=0;i<Math.min(100,all.length);i++){let it=all[i],c="lb-item";if(i===0)c+=" rank-1";else if(i===1)c+=" rank-2";else if(i===2)c+=" rank-3";if(it.isPlayer)c+=" is-player";let rs=(i===0)?"ğŸ¥‡":(i===1)?"ğŸ¥ˆ":(i===2)?"ğŸ¥‰":`ç¬¬${i+1}`;h+=`<div class="${c}"><div class="lb-rank">${rs}</div><div class="lb-name">${it.name}${it.isPlayer?" (ä½ )":""}</div><div class="lb-round">é€šå…³ ${it.round} è½®</div></div>`;}document.getElementById('lb-list').innerHTML=h;}

    function startGame(){state.name=document.getElementById('player-name-input').value.trim()||"æ— åæ•£ä»™";finalizeLoad();}
    function exportSaveData(){let ds="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(state));let dl=document.createElement('a');dl.setAttribute("href",ds);dl.setAttribute("download",`${state.name}_å­˜æ¡£.json`);document.body.appendChild(dl);dl.click();dl.remove();}
    function importSaveData(event){let f_=event.target.files[0];if(!f_)return;let r=new FileReader();r.onload=e=>{try{let d=JSON.parse(e.target.result);Object.assign(state,d);while(state.quests.length<questDefs.length)state.quests.push(0);finalizeLoad();}catch(err){alert("å­˜æ¡£æŸåï¼");}};r.readAsText(f_);event.target.value='';}
    function loadAutoSave(){let s=localStorage.getItem('lz_auto_save');if(s){try{Object.assign(state,JSON.parse(s));while(state.quests.length<questDefs.length)state.quests.push(0);finalizeLoad();}catch(e){alert("è‡ªåŠ¨å­˜æ¡£æŸå");}}else alert("æœªæ‰¾åˆ°è‡ªåŠ¨å­˜æ¡£");}
    setInterval(()=>{if(state.name!==""){localStorage.setItem('lz_auto_save',JSON.stringify(state));let d=new Date();document.getElementById('auto-save-time').innerText="å·²å­˜ "+d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');}},60000);
    function finalizeLoad(){if(state.t_qiankun===undefined)state.t_qiankun=0;if(state.t_yuanbao===undefined)state.t_yuanbao=0;if(state.t_shengsi===undefined)state.t_shengsi=0;document.getElementById('start-overlay').style.display='none';document.getElementById('display-name').innerText=`ã€${state.name}ã€‘`;if(state.pendingDsp===undefined)state.pendingDsp=0;generateBots();initQuestDOM();initTreasuresDOM();spawnMonster(state.cStage,true);lastLogicTick=Date.now();updateUI();fastSyncMonsterUI();uiSyncAutoMode();}

    function toggleAutoRebirth(){isAutoRebirth=!isAutoRebirth;let btn=document.getElementById('btn-toggle-auto'),inpt=document.getElementById('auto-stage-input');if(isAutoRebirth){let t=parseInt(inpt.value);if(isNaN(t)||t<10){alert("è½®æ¬¡å¿…é¡»>=10");isAutoRebirth=false;return;}btn.innerText="ğŸ›‘ åœæ­¢";btn.classList.add('active');inpt.disabled=true;processAutoUpgrade();}else{btn.innerText="å¯ç”¨";btn.classList.remove('active');inpt.disabled=false;}uiSyncAutoMode();}
    function uiSyncAutoMode(){document.querySelectorAll('.upg-item').forEach(el=>{if(el.parentElement.classList.contains('upgrades')){if(isAutoRebirth)el.classList.add('disabled-in-auto');else el.classList.remove('disabled-in-auto');}});updateUI();}
    function processAutoUpgrade(){if(!isAutoRebirth||isRebirthing)return;let b=true,lim=10000;while(b&&lim>0){b=false;lim--;for(let k of upgradeKeys){let ck=csMap[k];if(state.gold>=state[ck]){state.gold-=state[ck];if(k==='dmg'){state.dmg+=Math.pow(2,Math.floor(state.l_dmg/20));state.l_dmg++;state[ck]=Ce(state[ck]*1.1);}if(k==='cR'){state.critR+=0.1;state.l_cR++;state[ck]=Ce(state[ck]*1.1);}if(k==='cD'){state.critD+=1;state.l_cD++;state[ck]=Ce(state[ck]*1.1);}if(k==='dd'){state.deadlyD+=1;state.l_dd++;state[ck]*=2;}if(k.startsWith('a')){state['l_'+k]++;state[ck]=Ce(state[ck]*1.1);}b=true;}};}needUIUpdate=true;}
    function getUpgradeCost(k,n){let c=state[csMap[k]],s=0;for(let i=0;i<n;i++){s+=c;c=(k==='dd')?c*2:Ce(c*1.1);}return s;}
    function buyStateUpg(k,n){let cost=getUpgradeCost(k,n),ck=csMap[k];if(state.gold>=cost){state.gold-=cost;for(let i=0;i<n;i++){if(k==='dmg'){state.dmg+=Math.pow(2,Math.floor(state.l_dmg/20));state.l_dmg++;state[ck]=Ce(state[ck]*1.1);}if(k==='cR'){state.critR+=0.1;state.l_cR++;state[ck]=Ce(state[ck]*1.1);}if(k==='cD'){state.critD+=1;state.l_cD++;state[ck]=Ce(state[ck]*1.1);}if(k==='dd'){state.deadlyD+=1;state.l_dd++;state[ck]*=2;}if(k.startsWith('a')){state['l_'+k]++;state[ck]=Ce(state[ck]*1.1);}}updateUI();}}

    function initQuestDOM(){let h='';questDefs.forEach((q,i)=>{let rt=q.type==='dsp'?`${f(q.rewardBase)}ç•Œç‚¹`:`${f(q.rewardBase)}çµçŸ³`;h+=`<div class="quest-item"><span style="font-size:12px;font-weight:bold;color:#dfe6e9;">[ä»™å½•-${i+1}] ${q.desc}<br><small style="color:#7f8fa6;">(èµ: <span style="color:#dcb974;">${rt}</span>)</small></span><button id="btn-quest-${i}" class="btn-claim" disabled>æœªè¾¾æ ‡</button></div>`;});document.getElementById('quest-list').innerHTML=h;}
    function processQuests(){questDefs.forEach((q,i)=>{if(state.quests[i]===0&&q.check())state.quests[i]=1;let btn=document.getElementById(`btn-quest-${i}`);if(!btn)return;if(state.quests[i]===0){btn.className="btn-claim";btn.disabled=true;btn.innerText="æœªè¾¾æ ‡";btn.onclick=null;}else if(state.quests[i]===1){btn.className="btn-claim active";btn.disabled=false;btn.innerText="ğŸé¢†å–";btn.onclick=()=>claimQuest(i);}else{btn.className="btn-claim done";btn.disabled=true;btn.innerText="âœ…å·²é¢†";btn.onclick=null;}});}
    function claimQuest(i){if(state.quests[i]===1){let q=questDefs[i];if(q.type==='gold')state.gold+=q.rewardBase;if(q.type==='dsp')state.dsp+=q.rewardBase;state.quests[i]=2;needUIUpdate=true;if(isAutoRebirth)processAutoUpgrade();}}

    function initTreasuresDOM(){let h='';Object.keys(treasDefs).forEach(id=>{let d=treasDefs[id];h+=`<div class="treasure-item locked" id="tb-${id}"><strong style="color:${d.color};font-size:13px;margin-bottom:4px;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:2px;">${d.name} <span id="tb-lv-${id}" style="font-size:11px;color:#dcb974;"></span></strong><span style="color:#a4b0be;font-size:11px;line-height:1.4;margin-bottom:2px;">${d.desc} <strong id="tb-eff-${id}" style="color:#00cec9;">+0</strong><br><span id="tb-next-${id}" style="font-size:10px;color:#7f8fa6;"></span></span><div class="t-actions"><button class="t-act-btn" id="btn-t1-${id}" onclick="buyTreasure('${id}',1)"></button><button class="t-act-btn t-10x" id="btn-t10-${id}" style="display:none;" onclick="buyTreasure('${id}',10)"></button></div></div>`;});document.getElementById('treasure-grid').innerHTML=h;}
    function updateTreasuresUI(){Object.keys(treasDefs).forEach(id=>{let d=treasDefs[id],lv=state['t_'+id]||0,c1=getTreasureUpgradeCost(id,lv,1),c10=getTreasureUpgradeCost(id,lv,10);let el=document.getElementById(`tb-${id}`);if(!el)return;el.className=`treasure-item ${lv>0?'owned':'locked'}`;document.getElementById(`tb-lv-${id}`).innerText=lv===0?"":`(Lv.${lv})`;document.getElementById(`tb-eff-${id}`).innerText=`+${parseFloat(getTreasureEff(id).toFixed(2))}${d.unit}`;let ne=lv===0?d.unlockEff:(d.unlockEff+lv*(d.unlockEff*0.01));document.getElementById(`tb-next-${id}`).innerText=`(ä¸‹çº§: +${parseFloat(ne.toFixed(2))}${d.unit})`;let b1=document.getElementById(`btn-t1-${id}`),b10=document.getElementById(`btn-t10-${id}`);b1.disabled=(state.dsp<c1);b10.disabled=(state.dsp<c10);if(lv===0){b1.style.display='block';b10.style.display='none';b1.innerText=`ç‚¹äº® (${f(c1)}ç‚¹)`;}else{b1.style.display='inline-block';b10.style.display='inline-block';b1.innerText=`å‡çº§(${f(c1)})`;b10.innerText=`åè¿(${f(c10)})`;}});}
    function buyTreasure(id,n){let lv=state['t_'+id]||0,c=getTreasureUpgradeCost(id,lv,n);if(state.dsp>=c){state.dsp-=c;state['t_'+id]=lv+n;updateUI();}}

    function playRebirthAnimation(){return new Promise(resolve=>{let fl=document.getElementById('rebirth-flash'),tx=document.getElementById('rebirth-text'),vp=document.getElementById('viewport-main');fl.style.display='flex';void fl.offsetWidth;fl.style.opacity='1';tx.style.opacity='1';tx.style.transform='scale(1)';setTimeout(()=>{vp.style.opacity='0';resolve();setTimeout(()=>{fl.style.opacity='0';tx.style.opacity='0';tx.style.transform='scale(0.2)';vp.style.opacity='1';setTimeout(()=>{fl.style.display='none';},800);},1000);},600);});}
    async function doRebirth(skip=false){if(isRebirthing)return;let g=Ce(state.pendingDsp||0);if(!skip){if(!confirm(`ã€è½®å›Â·é‡å¡‘å¤©é“ã€‘\nä¸€åˆ‡è‹¦ä¿®åŒ–ä¸ºè™šæ— ï¼\næç‚¼ï¼š${f(g)} é™å¦–ç‚¹æ•°ã€‚\nç¡®è®¤è¸å…¥è½®å›ï¼Ÿ`))return;}isRebirthing=true;await playRebirthAnimation();state.dsp+=g;state.pendingDsp=0;state.rebirthCount++;state.cStage=1;state.maxStage=1;state.dmg=1;state.critR=0;state.critD=150;state.deadlyD=10;state.l_dmg=0;state.c_dmg=10;state.l_cR=0;state.c_cR=10;state.l_cD=0;state.c_cD=10;state.l_dd=0;state.c_dd=100000;state.l_a0=0;state.c_a0=1000;state.l_a1=0;state.c_a1=10000;state.l_a2=0;state.c_a2=100000;state.l_a3=0;state.c_a3=1000000;state.l_a4=0;state.c_a4=10000000;state.l_a5=0;state.c_a5=100000000;state.gold=Ce(1000000*getActualCoinMult());spawnMonster(state.cStage,true);isRebirthing=false;if(isAutoRebirth)processAutoUpgrade();updateUI();}

    function recordSnapshotData(){sn_emoji=elMonster.innerText;sn_color=elMonster.style.backgroundColor||elMonster.style.background;sn_boss=elMonster.classList.contains('boss');}
    function triggerHitAnim(){elMonster.classList.remove('hit');void elMonster.offsetWidth;elMonster.classList.add('hit');}
    function executeDeathAndSpawnVisuals(){if(document.visibilityState!=='visible'||isRebirthing)return;let g=document.createElement('div');g.className='monster-ghost';if(sn_boss)g.classList.add('boss');g.style.backgroundColor=sn_color;g.innerText=sn_emoji;elMonsterWrap.prepend(g);setTimeout(()=>{if(g)g.remove();},350);elMonster.classList.remove('spawn');void elMonster.offsetWidth;elMonster.classList.add('spawn');setTimeout(()=>{let dl=document.createElement('div');dl.className='dust-l';let dr=document.createElement('div');dr.className='dust-r';elMonsterWrap.appendChild(dl);elMonsterWrap.appendChild(dr);setTimeout(()=>{if(dl)dl.remove();if(dr)dr.remove();},400);},180);setTimeout(()=>{elMonster.classList.remove('spawn');},450);}

    function getTotalAutoRate(){let t=0;if(state.l_a0>0)t+=120+(state.l_a0-1)*2;if(state.l_a1>0)t+=50+(state.l_a1-1)*10;if(state.l_a2>0)t+=100+(state.l_a2-1)*20;if(state.l_a3>0)t+=150+(state.l_a3-1)*30;if(state.l_a4>0)t+=250+(state.l_a4-1)*50;if(state.l_a5>0)t+=500+(state.l_a5-1)*100;return Ce(t*(1+getTreasureEff('qiankun')/100));}

    setInterval(()=>{let now=Date.now(),delta=now-lastLogicTick;lastLogicTick=now;if(isRebirthing)return;
    if(isBoss&&bossExpireTime>0){let ls=Math.ceil((bossExpireTime-now)/1000);if(ls<=0){bossExpireTime=0;state.cStage--;spawnMonster(state.cStage,true);}else document.getElementById('timer-text').innerText=ls;}
    let tr=getTotalAutoRate();
    if(tr>=1800){let ea=(tr/60000)*delta,aCR=getActualCR(),aCD=getActualCD(),aDR=getActualDR(),aDD=getActualDD(),bd=Ce(state.dmg*getActualAtkMult()),avg=Ce(bd*(1-(aCR/100)+(aCR/100)*(aCD/100))*(1-(aDR/100)+(aDR/100)*aDD)),dp=Ce(ea*avg);if(dp>99999999)dp=Math.floor(dp/10000)*10000;let ka=false,sd=dp,sl=999999,sf=false;
    while(dp>0&&sl>0&&state.hpCurrent>0){if(dp>=state.hpCurrent){dp-=state.hpCurrent;state.hpCurrent=0;ka=true;let cm=getActualCoinMult(),rnd=Math.ceil(state.cStage/10),dm=rnd<5?1:(Math.floor(rnd/5)+1);state.pendingDsp+=Ce((isBoss?3:1)*dm*(1+getTreasureEff('shengsi')/100));if(isBoss){state.gold+=Ce((state.hpMax*3)*cm*(1+getTreasureEff('yuanbao')/100));bossExpireTime=0;if(isAutoRebirth&&rnd===parseInt(document.getElementById('auto-stage-input').value)){sf=true;break;}}else state.gold+=Ce(state.hpMax*cm);if(!pendingShouldPlayDeath&&document.visibilityState==='visible'){recordSnapshotData();pendingShouldPlayDeath=true;}if(state.cStage===state.maxStage)state.maxStage++;state.cStage++;isBoss=(((state.cStage-1)%10+1)===10);state.hpMax=getStageHp(state.cStage);state.hpCurrent=state.hpMax;}else{state.hpCurrent-=dp;dp=0;}sl--;}
    if(sd>0||ka)needUIUpdate=true;if(sd>0&&document.visibilityState==='visible'){triggerHitAnim();const rt=elMonster.getBoundingClientRect();buildFloatDmg(rt.left+rt.width/2,rt.top+rt.height/2+(Math.random()-0.5)*50,sd,'deadly',true);}if(sf)doRebirth(true);else if(ka&&isAutoRebirth)processAutoUpgrade();
    }else if(tr>0){autoAttackAccumulator+=(tr/60000)*delta;if(autoAttackAccumulator>=1){let c=Math.floor(autoAttackAccumulator);autoAttackAccumulator-=c;batchSimulateAttacks(c);}}
    if(needUIUpdate){updateUI();fastSyncMonsterUI();if(currentTabId==='leaderboard')renderLeaderboard();needUIUpdate=false;}
    if(pendingShouldPlayDeath){executeDeathAndSpawnVisuals();pendingShouldPlayDeath=false;}
    },100);

    function buildFloatDmg(x,y,dmg,type,isAuto){const d=document.createElement('div');d.classList.add('floating-damage');const mk=isAuto?`<span class="auto-dmg-mark">ğŸ¤–</span>`:``;if(type==='deadly'){d.classList.add('deadly-damage');d.innerHTML=`${mk}å¿…æ€ -${f(Ce(dmg))}`;}else if(type==='crit'){d.classList.add('crit-damage');d.innerHTML=`${mk}æš´å‡» -${f(Ce(dmg))}`;}else{d.innerHTML=`${mk}-${f(Ce(dmg))}`;}let rx=(Math.random()-0.5)*80,rect=elMonster.getBoundingClientRect();d.style.left=(x-rect.left+rx)+'px';d.style.top=(y-rect.top-20)+'px';elMonsterArea.appendChild(d);setTimeout(()=>d.remove(),800);}

    function batchSimulateAttacks(count){let aCR=getActualCR(),aCD=getActualCD(),aDR=getActualDR(),aDD=getActualDD(),bd=Ce(state.dmg*getActualAtkMult()),aL=count,lc=999999,bt=0,anyC=false,anyD=false;
    while(aL>0&&lc>0&&state.hpCurrent>0){if(aL<50){let isC=(Math.random()*100)<aCR,isD=(Math.random()*100)<aDR,fd=bd;if(isC){fd=Ce(fd*(aCD/100));anyC=true;}if(isD){fd=Ce(fd*aDD);anyD=true;}if(fd>99999999)fd=Math.floor(fd/10000)*10000;state.hpCurrent-=fd;bt+=fd;aL--;if(state.hpCurrent<=0)fastDefeatHandlingForNormal();}else{let ev=Ce(bd*(1-(aCR/100)+(aCR/100)*(aCD/100))*(1-(aDR/100)+(aDR/100)*aDD));if(ev>99999999)ev=Math.floor(ev/10000)*10000;let hk=Math.ceil(state.hpCurrent/Math.max(1,ev));if(hk<=aL){bt+=state.hpCurrent;aL-=hk;state.hpCurrent=0;anyC=true;fastDefeatHandlingForNormal();}else{state.hpCurrent-=(ev*aL);bt+=(ev*aL);anyC=true;aL=0;}}lc--;}
    if(bt>0&&document.visibilityState==='visible'){triggerHitAnim();const rt=elMonsterArea.getBoundingClientRect();buildFloatDmg(rt.left+rt.width/2,rt.top+rt.height/2+(Math.random()-0.5)*50,bt,anyD?'deadly':(anyC?'crit':'normal'),true);}needUIUpdate=true;}

    function fastDefeatHandlingForNormal(){let rnd=Math.ceil(state.cStage/10);state.pendingDsp+=Ce((isBoss?3:1)*(rnd<5?1:Math.floor(rnd/5)+1)*(1+getTreasureEff('shengsi')/100));if(!pendingShouldPlayDeath&&document.visibilityState==='visible'){recordSnapshotData();pendingShouldPlayDeath=true;}let cm=getActualCoinMult();if(isBoss){state.gold+=Ce((state.hpMax*3)*cm*(1+getTreasureEff('yuanbao')/100));bossExpireTime=0;}else state.gold+=Ce(state.hpMax*cm);if(state.cStage===state.maxStage)state.maxStage++;state.cStage++;if(isAutoRebirth){processAutoUpgrade();if(isBoss&&rnd===parseInt(document.getElementById('auto-stage-input').value)){doRebirth(true);return;}}isBoss=(((state.cStage-1)%10+1)===10);state.hpMax=getStageHp(state.cStage);state.hpCurrent=state.hpMax;}

    function attackHnd(event){if(state.hpCurrent<=0||isRebirthing)return;triggerHitAnim();let isC=(Math.random()*100)<getActualCR(),isD=(Math.random()*100)<getActualDR(),fd=Ce(state.dmg*getActualAtkMult());if(isC)fd=Ce(fd*(getActualCD()/100));if(isD)fd=Ce(fd*getActualDD());if(fd>99999999)fd=Math.floor(fd/10000)*10000;state.hpCurrent-=fd;let t='normal';if(isD)t='deadly';else if(isC)t='crit';buildFloatDmg(event.clientX,event.clientY,fd,t,false);if(state.hpCurrent<=0)fastDefeatHandlingForNormal();updateUI();fastSyncMonsterUI();needUIUpdate=false;if(pendingShouldPlayDeath){executeDeathAndSpawnVisuals();pendingShouldPlayDeath=false;}}

    function getAttackerUnlockDesc(id){let t={'a0':"120æ¬¡/åˆ†",'a1':"50æ¬¡/åˆ†",'a2':"100æ¬¡/åˆ†",'a3':"150æ¬¡/åˆ†",'a4':"250æ¬¡/åˆ†",'a5':"500æ¬¡/åˆ†"};return `è§£é”åé¢‘ç‡ +${t[id]}`;}

    function updateUI(){processQuests();updateTreasuresUI();
    document.getElementById('gold').innerText=f(state.gold);
    document.getElementById('stat-dmg').innerText=f(Ce(state.dmg*getActualAtkMult()));
    document.getElementById('stat-auto').innerText=f(Ce(getTotalAutoRate()));
    document.getElementById('stat-crit-rate').innerText=getActualCR().toFixed(1)+"%";
    document.getElementById('stat-crit-dmg').innerText=f(getActualCD())+"%";
    document.getElementById('stat-deadly-rate').innerText=getActualDR().toFixed(1)+"%";
    document.getElementById('stat-deadly-dmg').innerText=f(getActualDD())+"x";
    document.getElementById('stat-rebirths-main').innerText=state.rebirthCount;
    document.getElementById('stat-dsp-main').innerText=f(state.dsp);
    document.getElementById('current-rebirth-points').innerText=f(state.pendingDsp||0);
    let ok=Math.ceil(state.maxStage/10)>10;document.getElementById('btn-rebirth').disabled=!ok;document.getElementById('r-lock-stage').innerText=Math.ceil(state.maxStage/10);document.getElementById('rebirth-lock-text').style.display=ok?'none':'block';

    const uS=(id,ck,lk,dP,dT,uT)=>{let lv=state[lk],c1=getUpgradeCost(id,1),c10=getUpgradeCost(id,10);document.getElementById(`cost-${id}-1`).innerText=f(c1);document.getElementById(`cost-${id}-10`).innerText=f(c10);document.getElementById(`btn-${id}-1`).disabled=state.gold<c1;document.getElementById(`btn-${id}-10`).disabled=state.gold<c10;let b10=document.getElementById(`btn-${id}-10`);if(id.startsWith('a')&&lv===0)b10.style.display='none';else b10.style.display='inline-block';if(lv===0&&uT){document.getElementById(`lvl-${id}`).innerText="æœªè§£";document.getElementById(`desc-${id}`).innerHTML=`<span style="color:#7f8fa6;">${uT}</span>`;}else{document.getElementById(`lvl-${id}`).innerText=`Lv.${lv}`;document.getElementById(`desc-${id}`).innerHTML=`<span style="color:#2ed573;">ç²¾ç‚¼ï¼š${dP}</span><br><span style="color:#00cec9;">æ€»è®¡ï¼š${dT}</span>`;}};
    uS('dmg','c_dmg','l_dmg',`+${f(Math.pow(2,Math.floor(state.l_dmg/20)))}æ”»`,`+${f(state.dmg-1)}æ”»`,null);
    uS('cR','c_cR','l_cR',`+0.1%æš´ç‡`,`+${(state.l_cR*0.1).toFixed(1)}%`,null);
    uS('cD','c_cD','l_cD',`+1%æš´ä¼¤`,`+${state.l_cD}%`,null);
    uS('dd','c_dd','l_dd',`+1å€å¿…æ€`,`+${state.l_dd}å€`,null);
    uS('a0','c_a0','l_a0',`+2æ¬¡/åˆ†`,`+${state.l_a0>0?120+(state.l_a0-1)*2:0}æ¬¡/åˆ†`,getAttackerUnlockDesc('a0'));
    uS('a1','c_a1','l_a1',`+10æ¬¡/åˆ†`,`+${state.l_a1>0?50+(state.l_a1-1)*10:0}æ¬¡/åˆ†`,getAttackerUnlockDesc('a1'));
    uS('a2','c_a2','l_a2',`+20æ¬¡/åˆ†`,`+${state.l_a2>0?100+(state.l_a2-1)*20:0}æ¬¡/åˆ†`,getAttackerUnlockDesc('a2'));
    uS('a3','c_a3','l_a3',`+30æ¬¡/åˆ†`,`+${state.l_a3>0?150+(state.l_a3-1)*30:0}æ¬¡/åˆ†`,getAttackerUnlockDesc('a3'));
    uS('a4','c_a4','l_a4',`+50æ¬¡/åˆ†`,`+${state.l_a4>0?250+(state.l_a4-1)*50:0}æ¬¡/åˆ†`,getAttackerUnlockDesc('a4'));
    uS('a5','c_a5','l_a5',`+100æ¬¡/åˆ†`,`+${state.l_a5>0?500+(state.l_a5-1)*100:0}æ¬¡/åˆ†`,getAttackerUnlockDesc('a5'));
    document.getElementById('btn-challenge').style.display=(state.cStage<state.maxStage)?'block':'none';
    document.getElementById('ava-a0').classList.toggle('active',state.l_a0>0);document.getElementById('ava-a1').classList.toggle('active',state.l_a1>0);document.getElementById('ava-a2').classList.toggle('active',state.l_a2>0);document.getElementById('ava-a3').classList.toggle('active',state.l_a3>0);document.getElementById('ava-a4').classList.toggle('active',state.l_a4>0);document.getElementById('ava-a5').classList.toggle('active',state.l_a5>0);}

    function fastSyncMonsterUI(){let st=state.cStage,rnd=Math.ceil(st/10),midx=(st-1)%10+1,sI=document.getElementById('stage-info-text');if(isBoss){sI.innerHTML=`ç¬¬${rnd}è½® - ğŸŒŸ <span style="color:#ff6b81">${mythicNames[(st*13)%mythicNames.length]}</span>`;document.getElementById('boss-timer-wrap').style.display='inline-block';if(bossExpireTime===0)bossExpireTime=Date.now()+90000;}else{sI.innerHTML=`<span style="color:#2ed573;">ç¬¬${rnd}è½® - ${midx}é‡ [${mythicNames[(st*13)%mythicNames.length]}]</span>`;document.getElementById('boss-timer-wrap').style.display='none';}
    elMonster.classList.toggle('boss',isBoss);elMonster.style.background=`linear-gradient(135deg,hsl(${(isBoss?rnd*55:st*30)%360},${isBoss?65:30}%,55%),hsl(${(isBoss?rnd*55:st*30)%360},${isBoss?65:30}%,35%))`;elMonster.innerText=emojis[(st*7)%emojis.length];
    document.getElementById('hp-current').innerText=f(state.hpCurrent);document.getElementById('hp-max').innerText=f(state.hpMax);document.getElementById('hp-bar').style.width=Math.max(0,(state.hpCurrent/state.hpMax)*100)+'%';}

    function spawnMonster(st,rH=false){let rnd=Math.ceil(st/10),midx=(st-1)%10+1;isBoss=(midx===10);state.hpMax=getStageHp(st);if(rH||state.hpCurrent<=0)state.hpCurrent=state.hpMax;if(!isBoss)bossExpireTime=0;needUIUpdate=true;}
    function challengeBoss(){state.cStage=state.maxStage;spawnMonster(state.cStage,true);updateUI();fastSyncMonsterUI();}
</script>
</body>
</html>